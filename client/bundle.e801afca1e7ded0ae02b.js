(()=>{"use strict";class e extends Phaser.Text{constructor({game:e,x:t,y:i,text:s,style:a}){super(e,t,i,s,a),this.anchor.setTo(.5),this.game.add.existing(this)}}Phaser.Button,Phaser.Button;class t extends Phaser.Group{constructor({game:e,availableGames:t,callback:i,callbackContext:s,x:a,y:o,style:h}){super(e);let n=o;for(let e of t){let t=new Phaser.Image(this.game,a,n,"slot_backdrop"),o=new Phaser.Button(this.game,t.width-100,12,"list_icon",i.bind(s,{game_id:e.id}),null,1,0,2,1),l=new Phaser.Text(this.game,30,25,`Join Game: ${e.name}`,h);t.addChild(o),t.addChild(l),this.add(t),n+=105}}destroy(){this.callAll("kill")}}class i extends Phaser.Group{constructor({game:e,max_players:t,players:i,x:s,y:a,asset_empty:o,asset_player:h,style:n}){super(e);let l=s;for(let e=0;e<t;e++){let t,s,r=i[e];if(r){t=new Phaser.Image(this.game,l,a,h+r.skin);const e=r.displayName||r.skin;s=new Phaser.Text(this.game,t.width/2,t.height+15,e,n),s.anchor.setTo(.5),t.addChild(s)}else t=new Phaser.Image(this.game,l,a,o);this.add(t),l+=170}}destroy(){this.callAll("kill")}}class s extends Phaser.Group{constructor({game:e,asset:t,x:i,y:s}){super(e),this.picture=new Phaser.Image(this.game,i,s-20,t),this.picture.anchor.setTo(.5),this.add(this.picture),this.tween=this.game.add.tween(this.picture),this.tween.to({y:this.picture.y-25,alpha:0},600),this.tween.onComplete.add(this.finish,this),this.tween.start()}finish(){this.callAll("kill")}}class a extends Phaser.State{create(){this.game.stage.disableVisibilityChange=!0,this.game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.game.scale.pageAlignHorizontally=!0,this.game.scale.pageAlignVertically=!0;const t=()=>{try{this.game.scale.refresh()}catch(e){}};window.addEventListener("resize",t),t();const i=new e({game:this.game,x:this.game.world.centerX,y:this.game.world.centerY,text:"Loading...",style:{font:'30px Arial, "Noto Sans TC", "Microsoft JhengHei", sans-serif',fill:"#FFFFFF"}}),s=()=>{try{i&&i.destroy&&i.destroy()}catch(e){}this.state.start("Preload")};try{document&&document.fonts&&document.fonts.load?Promise.all([document.fonts.load('16px "Noto Sans TC"'),document.fonts.load('16px "Microsoft JhengHei"'),document.fonts.load("16px Arial")]).then(s).catch(s):s()}catch(e){s()}try{this.game.sound.mute=!1,this.game.input.onDown.addOnce(()=>{try{this.game.sound&&this.game.sound.context&&"suspended"===this.game.sound.context.state&&this.game.sound.context.resume(),this.game.sound&&this.game.sound.unlock&&this.game.sound.unlock()}catch(e){}})}catch(e){}}}const o=a;class h extends Phaser.State{preload(){try{this.load.onFileError.add((e,t)=>{try{window.UK01Log&&window.UK01Log(`LOAD_ERR key=${e} url=${t&&t.url}`)}catch(e){}}),this.load.onFileComplete.add((e,t)=>{try{window.UK01Loading&&window.UK01Loading.set(e,`è¼‰å…¥ä¸­ï¼š${t}`),window.UK01Log&&e<100&&window.UK01Log(`LOAD ${e}% ${t}`)}catch(e){}}),this.load.onLoadComplete.add(()=>{try{window.UK01Loading&&window.UK01Loading.set(100,"å®Œæˆ"),window.UK01Log&&window.UK01Log("LOAD_DONE")}catch(e){}})}catch(e){}this.load.image("main_menu","images/menu/main_menu.png"),this.load.image("slot_backdrop","images/menu/slot_backdrop.png"),this.load.spritesheet("buttons","images/menu/buttons.png",200,75),this.load.spritesheet("check_icon","images/menu/accepts.png",75,75),this.load.spritesheet("list_icon","images/menu/game_enter.png",75,75),this.load.image("hot_map_preview","images/menu/hot_map_preview.png"),this.load.image("cold_map_preview","images/menu/cold_map_preview.png"),this.load.image("arena_map_preview","images/menu/arena_map_preview.png?v=2"),this.load.image("open_map_preview","images/menu/open_map_preview.png?v=3"),this.load.image("rune_lab_preview","images/menu/rune_lab_preview.png?v=1"),this.load.image("mirror_temple_preview","images/menu/mirror_temple_preview.png?v=1"),this.load.image("trap_garden_preview","images/menu/trap_garden_preview.png?v=1"),this.load.image("prev","images/menu/left_arrow.png"),this.load.image("next","images/menu/right_arrow.png"),this.load.image("tiles","maps/tileset.png"),this.load.tilemap("hot_map","maps/hot_map.json",null,Phaser.Tilemap.TILED_JSON),this.load.tilemap("cold_map","maps/cold_map.json",null,Phaser.Tilemap.TILED_JSON),this.load.tilemap("arena_map","maps/arena_map.json",null,Phaser.Tilemap.TILED_JSON),this.load.tilemap("open_map","maps/open_map.json",null,Phaser.Tilemap.TILED_JSON),this.load.tilemap("rune_lab","maps/rune_lab.json",null,Phaser.Tilemap.TILED_JSON),this.load.tilemap("mirror_temple","maps/mirror_temple.json",null,Phaser.Tilemap.TILED_JSON),this.load.tilemap("trap_garden","maps/trap_garden.json",null,Phaser.Tilemap.TILED_JSON),this.load.spritesheet("explosion_center","images/game/explosion_center.png",35,35),this.load.spritesheet("explosion_horizontal","images/game/explosion_horizontal.png",35,35),this.load.spritesheet("explosion_vertical","images/game/explosion_vertical.png",35,35),this.load.spritesheet("explosion_up","images/game/explosion_up.png",35,35),this.load.spritesheet("explosion_right","images/game/explosion_right.png",35,35),this.load.spritesheet("explosion_down","images/game/explosion_down.png",35,35),this.load.spritesheet("explosion_left","images/game/explosion_left.png",35,35),this.load.spritesheet("spoil_tileset","images/game/spoil_tileset.png",35,35),this.load.spritesheet("bone_tileset","images/game/bone_tileset.png",35,35),this.load.spritesheet("bomb_tileset","images/game/bombs.png",35,35),this.load.image("speed_up_bonus","images/game/speed_up_bonus.png"),this.load.image("speed_up_no_bonus","images/game/speed_up_no_bonus.png"),this.load.image("delay_up_bonus","images/game/delay_up_bonus.png"),this.load.image("delay_up_no_bonus","images/game/delay_up_no_bonus.png"),this.load.image("power_up_bonus","images/game/power_up_bonus.png"),this.load.image("placeholder_power","images/game/placeholder_power.png"),this.load.image("placeholder_speed","images/game/placeholder_speed.png"),this.load.image("placeholder_time","images/game/placeholder_time.png"),this.load.image("disease_icon","images/game/disease_icon.svg"),this.load.image("disease_tint","images/game/disease_icon.svg"),this.load.image("light_mask","images/game/light_mask.svg"),this.load.spritesheet("portal_fx","images/game/portal_fx.png",35,35),this.load.spritesheet("speed_fx","images/game/speed_fx.png",35,35),this.load.image("ghost_icon","images/game/ghost_icon.png"),this.load.audio("sfx_portal",["sfx/portal.wav"]),this.load.audio("sfx_speed",["sfx/speed.wav"]),this.load.audio("sfx_explosion",["sfx/explosion.wav"]),this.load.audio("sfx_death",["sfx/death.wav"]),this.load.audio("bgm_main",["sfx/bgm.wav"]);const e=e=>`images/game/cosmetics/${e}?v=20260206_14`;this.load.image("cosmetic_base",e("base.png")),this.load.image("cosmetic_char_1",e("characters/char_1_pink_happy.png")),this.load.image("cosmetic_char_2",e("characters/char_2_pink_cry.png")),this.load.image("cosmetic_char_3",e("characters/char_3_yellow_happy.png")),this.load.image("cosmetic_char_4",e("characters/char_4_yellow_cry.png")),this.load.image("cosmetic_char_5",e("characters/char_5_blue_happy.png")),this.load.image("cosmetic_char_6",e("characters/char_6_blue_cry.png")),this.load.image("cosmetic_char_7",e("characters/char_7_mint_happy.png")),this.load.image("cosmetic_char_8",e("characters/char_8_mint_cry.png")),this.load.image("cosmetic_transparent",e("transparent35.png"));for(let t=1;t<=10;t++)this.load.image(`cosmetic_hat_${t}`,e(`hat_${t}.png`)),this.load.image(`cosmetic_hair_${t}`,e(`hair_${t}.png`)),this.load.image(`cosmetic_outfit_${t}`,e(`outfit_${t}.png`));for(let t=1;t<=4;t++)this.load.image(`cosmetic_face_${t}`,e(`face_${t}.png`));for(let t=1;t<=6;t++)this.load.image(`cosmetic_pattern_${t}`,e(`pattern_${t}.png`));this.load.image("bomberman_head_blank","images/game/chars/0-face.png"),this.load.image("bomberman_head_Theodora","images/game/chars/1-face.png"),this.load.image("bomberman_head_Ringo","images/game/chars/2-face.png"),this.load.image("bomberman_head_Jeniffer","images/game/chars/3-face.png"),this.load.image("bomberman_head_Godard","images/game/chars/4-face.png"),this.load.image("bomberman_head_Biarid","images/game/chars/5-face.png"),this.load.image("bomberman_head_Solia","images/game/chars/6-face.png"),this.load.image("bomberman_head_Kedan","images/game/chars/7-face.png"),this.load.image("bomberman_head_Nigob","images/game/chars/8-face.png"),this.load.image("bomberman_head_Baradir","images/game/chars/9-face.png"),this.load.image("bomberman_head_Raviel","images/game/chars/10-face.png"),this.load.image("bomberman_head_Valpo","images/game/chars/11-face.png"),this.load.spritesheet("bomberman_Theodora","images/game/chars/1-preview.png",32,32),this.load.spritesheet("bomberman_Ringo","images/game/chars/2-preview.png",32,32),this.load.spritesheet("bomberman_Jeniffer","images/game/chars/3-preview.png",32,32),this.load.spritesheet("bomberman_Godard","images/game/chars/4-preview.png",32,32),this.load.spritesheet("bomberman_Biarid","images/game/chars/5-preview.png",32,32),this.load.spritesheet("bomberman_Solia","images/game/chars/6-preview.png",32,32),this.load.spritesheet("bomberman_Kedan","images/game/chars/7-preview.png",32,32),this.load.spritesheet("bomberman_Nigob","images/game/chars/8-preview.png",32,32),this.load.spritesheet("bomberman_Baradir","images/game/chars/9-preview.png",32,32),this.load.spritesheet("bomberman_Raviel","images/game/chars/10-preview.png",32,32),this.load.spritesheet("bomberman_Valpo","images/game/chars/11-preview.png",32,32)}create(){try{window.UK01Loading&&window.UK01Loading.done()}catch(e){}this.state.start("Menu")}}const n=h;class l extends Phaser.State{init(){this.slotsWithGame=null,clientSocket.on("display pending games",this.displayPendingGames.bind(this))}create(){this.add.image(this.game.world.centerX,this.game.world.centerY,"main_menu").anchor.setTo(.5);try{window.UK01Menu&&window.UK01Menu.showMenu&&window.UK01Menu.showMenu()}catch(e){}clientSocket.emit("enter lobby",this.displayPendingGames.bind(this))}update(){}hostGameAction(){clientSocket.emit("leave lobby"),this.state.start("SelectMap")}displayPendingGames(e){this.slotsWithGame&&this.slotsWithGame.destroy(),this.slotsWithGame=new t({game:this.game,availableGames:e,callback:this.joinGameAction,callbackContext:this,x:this.game.world.centerX-220,y:160,style:{font:'35px Arial, "Noto Sans TC", "Microsoft JhengHei", sans-serif',fill:"#efefef",stroke:"#ae743a",strokeThickness:3}})}joinGameAction(e){clientSocket.emit("leave lobby"),this.state.start("PendingGame",!0,!1,e)}}const r=l,d=35,m="layer_1",c=["hot_map","cold_map","arena_map","open_map","rune_lab","mirror_temple","trap_garden"];class p extends Phaser.State{init(){this.slider=new phaseSlider(this)}create(){this.add.image(this.game.world.centerX,this.game.world.centerY,"main_menu").anchor.setTo(.5);try{window.UK01Menu&&window.UK01Menu.showMaps&&window.UK01Menu.showMaps()}catch(e){}}confirmStageSelection(){let e=c[this.slider.getCurrentIndex()];clientSocket.emit("create game",e,this.joinToNewGame.bind(this))}joinToNewGame(e){if(e&&e.error)return void alert(e.message||e.error);const t=e&&e.game_id?e.game_id:e;this.state.start("PendingGame",!0,!1,t)}}const g=p;class y extends Phaser.State{init(e){this.slotsWithPlayer=null,this.game_id=e&&e.game_id?e.game_id:e,clientSocket.on("update game",this.displayGameInfo.bind(this)),clientSocket.on("launch game",this.launchGame.bind(this)),clientSocket.emit("enter pending game",{game_id:this.game_id})}create(){this.add.image(this.game.world.centerX,this.game.world.centerY,"main_menu").anchor.setTo(.5);try{window.UK01Pending&&window.UK01Pending.show&&window.UK01Pending.show(),window.UK01Menu&&window.UK01Menu.hideMenu&&window.UK01Menu.hideMenu()}catch(e){}this.gameTitle=new e({game:this.game,x:this.game.world.centerX,y:this.game.world.centerY-215,text:"",style:{font:'35px Arial, "Noto Sans TC", "Microsoft JhengHei", sans-serif',fill:"#9ec0ba",stroke:"#6f7975",strokeThickness:3}})}setAICount(e){this.aiCount=Math.max(0,Math.min(3,e)),this.aiText&&(this.aiText.text=`AI: ${this.aiCount}`),clientSocket.emit("set ai count",{count:this.aiCount})}setAIDifficulty(e){this.aiDifficulty=e,this.aiDiffText&&(this.aiDiffText.text=`é›£åº¦: ${this.aiDifficulty}`),clientSocket.emit("set ai difficulty",{difficulty:this.aiDifficulty})}displayGameInfo({current_game:e}){let t=Object.values(e.players);this.gameTitle.text=e.name,this.slotsWithPlayer&&this.slotsWithPlayer.destroy(),this.slotsWithPlayer=new i({game:this.game,max_players:e.max_players,players:t,x:this.game.world.centerX-245,y:this.game.world.centerY-80,asset_empty:"bomberman_head_blank",asset_player:"bomberman_head_",style:{font:'20px Arial, "Noto Sans TC", "Microsoft JhengHei", sans-serif',fill:"#48291c"}});try{window.UK01Pending&&window.UK01Pending.updateFromGame&&window.UK01Pending.updateFromGame(e)}catch(e){}}leaveGameAction(){clientSocket.emit("leave pending game"),this.state.start("Menu")}startGameAction(){clientSocket.emit("start game")}launchGame(e){this.state.start("Play",!0,!1,e)}}const f=y,u=function(e,t){for(let i of t.children)if(i.id===e)return i;return null},_=function(e,t){let i=u(e,t);i&&i.destroy()};class w{constructor({game:e,player:t}){this.game=e,this.player=t,this.style={font:"14px Arial",fill:"#ffffff",align:"left"},this.redStyle={font:"30px Arial",fill:"#ff0044",align:"center"},this.hud=this.game.add.group(),this.hud.fixedToCamera=!0;let i=new Phaser.Image(this.game,5,2,"placeholder_speed");this.speedText=new Phaser.Text(this.game,35,7,this.speedLabel(),this.style),i.addChild(this.speedText),this.hud.add(i);let s=new Phaser.Image(this.game,110,2,"placeholder_power");this.powerText=new Phaser.Text(this.game,35,7,this.powerLabel(),this.style),s.addChild(this.powerText),this.hud.add(s);let a=new Phaser.Image(this.game,215,2,"placeholder_time");this.delayText=new Phaser.Text(this.game,35,7,this.delayLabel(),this.style),a.addChild(this.delayText),this.hud.add(a);let o=new Phaser.Image(this.game,320,2,"placeholder_power");o.alpha=.7,this.lifeText=new Phaser.Text(this.game,35,7,this.lifeLabel(),this.style),o.addChild(this.lifeText),this.hud.add(o);let h=new Phaser.Image(this.game,425,2,"placeholder_time");h.alpha=.6,this.bombText=new Phaser.Text(this.game,35,7,this.bombLabel(),this.style),h.addChild(this.bombText),this.hud.add(h);let n=new Phaser.Image(this.game,320,2,"ghost_icon");n.alpha=.85,this.ghostText=new Phaser.Text(this.game,35,7,"",this.style),n.addChild(this.ghostText),n.visible=!1,this.ghostIcon=n,this.hud.add(n),this._ghostTimer=null,this.deadText=this.game.add.text(this.game.world.centerX,this.game.world.height-30,"You died :(",this.redStyle),this.deadText.anchor.set(.5),this.deadText.visible=!1,this.deadText.fixedToCamera=!0}refreshStatistic(){this.speedText.text=this.speedLabel(),this.powerText.text=this.powerLabel(),this.delayText.text=this.delayLabel(),this.lifeText&&(this.lifeText.text=this.lifeLabel()),this.bombText&&(this.bombText.text=this.bombLabel())}refreshLives(){this.lifeText&&(this.lifeText.text=this.lifeLabel())}refreshBombs(){this.bombText&&(this.bombText.text=this.bombLabel())}showGhost(e){if(!this.ghostIcon)return;if(this.ghostIcon.visible=!0,this._ghostTimer){try{this.game.time.events.remove(this._ghostTimer)}catch(e){}this._ghostTimer=null}const t=()=>{const t=Math.max(0,e-this.game.time.now);this.ghostText.text=`${(t/1e3).toFixed(1)}s`,t<=0&&this.hideGhost()};t(),this._ghostTimer=this.game.time.events.loop(150,t)}hideGhost(){if(this.ghostIcon&&(this.ghostIcon.visible=!1),this._ghostTimer){try{this.game.time.events.remove(this._ghostTimer)}catch(e){}this._ghostTimer=null}}showDeadInfo(){this.deadText.visible=!0}speedLabel(){return this.player.speed}powerLabel(){return`x ${this.player.power}`}delayLabel(){return this.player.delay/1e3+" sec."}lifeLabel(){return`x ${this.player.lives||0}`}bombLabel(){return`${this.player.maxBombs||1}B ${this.player.mineAmmo||0}M`}}class b extends Phaser.Sprite{constructor({game:e,id:t,spawn:i,skin:s,displayName:a,avatarParts:o}){super(e,i.x,i.y,"bomberman_"+s),this.game=e,this.id=t,this.prevPosition={x:i.x,y:i.y},this.delay=2e3,this.power=1,this.speed=150,this.tileSpeedMultiplier=1,this._lastBombTime=0,this.shieldUntil=0,this.ghostUntil=0,this.hasRemote=!1,this.hasKick=!1,this.diseaseUntil=0,this.passwallUntil=0,this.reverseUntil=0,this.slowUntil=0,this.confuseUntil=0,this.lives=3,this.maxLives=5,this.maxBombs=1,this.hasBombPass=!1,this.mineAmmo=0,this.game.add.existing(this),this.game.physics.arcade.enable(this),this.body.setSize(20,20,6,6),this.touchLeft=!1,this.touchRight=!1,this.touchUp=!1,this.touchDown=!1,this.touchBomb=!1,e.time.events.loop(200,this.positionUpdaterLoop.bind(this)),this.animations.add("up",[9,10,11],15,!0),this.animations.add("down",[0,1,2],15,!0),this.animations.add("right",[6,7,8],15,!0),this.animations.add("left",[3,4,5],15,!0),this.info=new w({game:this.game,player:this}),this.defineKeyboard(),this.defineSelf(a||s),this.avatarParts=o||null,this.applyAvatarParts(this.avatarParts)}update(){this.alive&&(this.handleMoves(),this.handleBombs()),this.animateCosmetics()}defineKeyboard(){this.upKey=this.game.input.keyboard.addKey(Phaser.Keyboard.UP),this.downKey=this.game.input.keyboard.addKey(Phaser.Keyboard.DOWN),this.leftKey=this.game.input.keyboard.addKey(Phaser.Keyboard.LEFT),this.rightKey=this.game.input.keyboard.addKey(Phaser.Keyboard.RIGHT),this.wKey=this.game.input.keyboard.addKey(Phaser.Keyboard.W),this.aKey=this.game.input.keyboard.addKey(Phaser.Keyboard.A),this.sKey=this.game.input.keyboard.addKey(Phaser.Keyboard.S),this.dKey=this.game.input.keyboard.addKey(Phaser.Keyboard.D),this.spaceKey=this.game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR)}handleMoves(){this.body.velocity.set(0);let e=[],t=this.speed*(this.tileSpeedMultiplier||1);this.isSlowed&&this.isSlowed()&&(t*=.55);let i=this.leftKey.isDown||this.aKey&&this.aKey.isDown||this.touchLeft,s=this.rightKey.isDown||this.dKey&&this.dKey.isDown||this.touchRight,a=this.upKey.isDown||this.wKey&&this.wKey.isDown||this.touchUp,o=this.downKey.isDown||this.sKey&&this.sKey.isDown||this.touchDown;if(this.isReversed&&this.isReversed()){const e=i,t=a;i=s,s=e,a=o,o=t}if(this.isConfused&&this.isConfused()){const e=i,t=a;i=s,s=e,a=o,o=t}this.isSlowed&&this.isSlowed(),i?(this.body.velocity.x=-t,e.push("left")):s&&(this.body.velocity.x=t,e.push("right")),a?(this.body.velocity.y=-t,e.push("up")):o&&(this.body.velocity.y=t,e.push("down"));let h=e[0];h?this.animations.play(h):this.animations.stop()}handleBombs(){if(this.game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR)||this.touchBomb){let e=this.game.time.now;e>this._lastBombTime&&(this._lastBombTime=e+this.delay,clientSocket.emit("create bomb",{col:this.currentCol(),row:this.currentRow()}))}}currentCol(){return Math.floor(this.body.position.x/d)}currentRow(){return Math.floor(this.body.position.y/d)}positionUpdaterLoop(){let e={x:this.position.x,y:this.position.y};this.prevPosition.x===e.x&&this.prevPosition.y===e.y||(clientSocket.emit("update player position",e),this.prevPosition=e)}becomesDead(){this.info.showDeadInfo(),this.kill()}pickSpoil(e){0===e&&this.increaseSpeed(),1===e&&this.increasePower(),2===e&&this.increaseDelay(),3===e&&this.activateShield(),4===e&&this.enableRemote(),5===e&&this.enableKick(),6===e&&this.activateGhost(),7===e&&this.infectDisease(),8===e&&this.gainLife(),9===e&&this.activatePassWall(),10===e&&this.activateReverse(),11===e&&this.increaseBombCapacity(),12===e&&this.enableBombPass(),13===e&&this.activateSlow(),14===e&&this.activateConfuse(),15===e&&this.gainMine()}isShielded(){return this.shieldUntil&&this.game.time.now<this.shieldUntil}isGhosted(){return this.ghostUntil&&this.game.time.now<this.ghostUntil}isDiseased(){return this.diseaseUntil&&this.game.time.now<this.diseaseUntil}isSlowed(){return this.slowUntil&&this.game.time.now<this.slowUntil}isConfused(){return this.confuseUntil&&this.game.time.now<this.confuseUntil}increaseBombCapacity(){this.maxBombs=Math.min(5,(this.maxBombs||1)+1),this.info&&this.info.refreshBombs&&this.info.refreshBombs()}enableBombPass(){this.hasBombPass=!0,this.game.time.events.add(250,()=>{try{this.tint=10083839}catch(e){}})}activateSlow(){this.slowUntil=this.game.time.now+9e3,this.tint=8956671,this.game.time.events.add(9e3,()=>{this.isShielded()||this.isGhosted()||this.isPassWalled()||this.isDiseased()||this.isReversed()||this.isConfused()||(this.tint=16777215)})}activateConfuse(){this.confuseUntil=this.game.time.now+8e3,this.tint=16777215,this.game.time.events.add(8e3,()=>{this.isShielded()||this.isGhosted()||this.isPassWalled()||this.isDiseased()||this.isReversed()||this.isSlowed()||(this.tint=16777215)})}gainMine(){this.mineAmmo=Math.min(5,(this.mineAmmo||0)+1),this.info&&this.info.refreshBombs&&this.info.refreshBombs()}increaseSpeed(){let e="speed_up_no_bonus";this.speed<350&&(this.speed=this.speed+50,this.info.refreshStatistic(),e="speed_up_bonus"),new s({game:this.game,asset:e,x:this.position.x,y:this.position.y})}increaseDelay(){let e="delay_up_no_bonus";this.delay>500&&(this.delay-=500,this.info.refreshStatistic(),e="delay_up_bonus"),new s({game:this.game,asset:e,x:this.position.x,y:this.position.y})}increasePower(){this.power+=1,this.info.refreshStatistic(),new s({game:this.game,asset:"power_up_bonus",x:this.position.x,y:this.position.y})}activateShield(){this.shieldUntil=this.game.time.now+3e3,this.tint=6737151,this.game.time.events.add(3e3,()=>{this.isGhosted&&this.isGhosted()?(this.tint=11007999,this.alpha=.65):this.tint=16777215}),new s({game:this.game,asset:"placeholder_time",x:this.position.x,y:this.position.y})}enableRemote(){this.hasRemote=!0,new s({game:this.game,asset:"placeholder_power",x:this.position.x,y:this.position.y})}enableKick(){this.hasKick=!0,new s({game:this.game,asset:"placeholder_speed",x:this.position.x,y:this.position.y})}applyAvatarParts(e){try{if(this._cosmetics)for(const e of this._cosmetics)try{e.destroy()}catch(e){}if(this._cosmetics=[],!e)return;const t=(e,t,i,s=1)=>{if(!e)return;const a=this.game.add.sprite(t,i,e);a.anchor.setTo(.5),a.scale.setTo(.34),a.alpha=s,a._baseY=i,this.addChild(a),this._cosmetics.push(a)};t(e&&e.character?"cosmetic_"+e.character:"cosmetic_base",16,16,1);const i=e.hair?"cosmetic_"+e.hair:null,s=e.outfit?"cosmetic_"+e.outfit:null,a=e.hat?"cosmetic_"+e.hat:null,o=e.face?"cosmetic_"+e.face:null,h=e.pattern?"cosmetic_"+e.pattern:null;try{this.loadTexture("cosmetic_transparent")}catch(e){}t(s,16,22,.98),t(h,16,22,.99),t(o,16,14,.995),t(i,16,12,.999),t(a,16,6,.999)}catch(e){}}animateCosmetics(){try{if(!this._cosmetics||!this._cosmetics.length)return;const e=Math.abs(this.body.velocity.x)>1||Math.abs(this.body.velocity.y)>1;this._cosBobT||(this._cosBobT=0),e?this._cosBobT+=this.game.time.elapsedMS||16:this._cosBobT=0;const t=e?1.6*Math.sin(this._cosBobT/90):0;for(const e of this._cosmetics){if(!e)continue;const i="number"==typeof e._baseY?e._baseY:e.y;e.y=i+t}}catch(e){}}activateGhost(){this.ghostUntil=this.game.time.now+15e3,this.alpha=.65,this.tint=11007999,this.info&&this.info.showGhost&&this.info.showGhost(this.ghostUntil),this.game.time.events.add(15e3,()=>{this.alpha=1,this.isShielded&&this.isShielded()||(this.tint=16777215),this.info&&this.info.hideGhost&&this.info.hideGhost()}),new s({game:this.game,asset:"ghost_icon",x:this.position.x,y:this.position.y})}infectDisease(){this.diseaseUntil=this.game.time.now+2e4,this.tint=5635925,this.game.time.events.add(2e4,()=>{this.isShielded()||this.isGhosted()||this.isPassWalled()||this.isReversed()||(this.tint=16777215)}),new s({game:this.game,asset:"disease_icon",x:this.position.x,y:this.position.y})}gainLife(){this.lives=Math.min(this.maxLives||5,(this.lives||0)+1),this.info&&this.info.refreshLives&&this.info.refreshLives();try{new s({game:this.game,asset:"placeholder_power",x:this.position.x,y:this.position.y})}catch(e){}}activatePassWall(){this.passwallUntil=this.game.time.now+1e4,this.tint=6748159,this.game.time.events.add(1e4,()=>{this.isShielded()||this.isGhosted()||this.isReversed()||this.isDiseased()||(this.tint=16777215)}),this.info&&this.info.showPassWall&&this.info.showPassWall(this.passwallUntil)}isPassWalled(){return this.passwallUntil&&this.game.time.now<this.passwallUntil}activateReverse(){this.reverseUntil=this.game.time.now+8e3,this.tint=16764006,this.game.time.events.add(8e3,()=>{this.isShielded()||this.isGhosted()||this.isPassWalled()||this.isDiseased()||(this.tint=16777215)}),this.info&&this.info.showReverse&&this.info.showReverse(this.reverseUntil)}isReversed(){return this.reverseUntil&&this.game.time.now<this.reverseUntil}defineSelf(t){let i=new e({game:this.game,x:17.5,y:-10,text:`âœ® ${t} âœ®`,style:{font:'15px Arial, "Noto Sans TC", "Microsoft JhengHei", sans-serif',fill:"#FFFFFF",stroke:"#000000",strokeThickness:3}});this.addChild(i)}}class x extends Phaser.Sprite{constructor({game:e,id:t,spawn:i,skin:s,displayName:a,avatarParts:o}){super(e,i.x,i.y,"bomberman_"+s),this.game=e,this.id=t,this.currentPosition=i,this.lastMoveAt=0,this.game.physics.arcade.enable(this),this.body.setSize(20,20,6,6),this.body.immovable=!0,this.animations.add("up",[9,10,11],15,!0),this.animations.add("down",[0,1,2],15,!0),this.animations.add("right",[6,7,8],15,!0),this.animations.add("left",[3,4,5],15,!0),this.defineSelf(a||s),this.applyAvatarParts(o||null)}update(){this.animateCosmetics()}goTo(e){this.lastMoveAt=this.game.time.now,this._movingUntil=this.game.time.now+200,this.animateFace(e),this.game.add.tween(this).to(e,200,Phaser.Easing.Linear.None,!0)}animateFace(e){let t="down",i=e.x-this.currentPosition.x,s=e.y-this.currentPosition.y;i<0?t="left":i>0?t="right":s<0?t="up":s>0&&(t="down"),this.animations.play(t),this.currentPosition=e}applyAvatarParts(e){try{if(this._cosmetics)for(const e of this._cosmetics)try{e.destroy()}catch(e){}if(this._cosmetics=[],!e)return;const t=(e,t,i,s=1)=>{if(!e)return;const a=this.game.add.sprite(t,i,e);a.anchor.setTo(.5),a.scale.setTo(.34),a.alpha=s,a._baseY=i,this.addChild(a),this._cosmetics.push(a)};t(e&&e.character?"cosmetic_"+e.character:"cosmetic_base",16,16,1);const i=e.hair?"cosmetic_"+e.hair:null,s=e.outfit?"cosmetic_"+e.outfit:null,a=e.hat?"cosmetic_"+e.hat:null,o=e.face?"cosmetic_"+e.face:null,h=e.pattern?"cosmetic_"+e.pattern:null;try{this.loadTexture("cosmetic_transparent")}catch(e){}t(s,16,22,.98),t(h,16,22,.99),t(o,16,14,.995),t(i,16,12,.999),t(a,16,6,.999)}catch(e){}}animateCosmetics(){try{if(!this._cosmetics||!this._cosmetics.length)return;this._cosBobT||(this._cosBobT=0);const e=!!(this._movingUntil&&this.game.time.now<this._movingUntil);e?this._cosBobT+=this.game.time.elapsedMS||16:this._cosBobT=0;const t=e?1.6*Math.sin(this._cosBobT/90):0;for(const e of this._cosmetics){if(!e)continue;const i="number"==typeof e._baseY?e._baseY:e.y;e.y=i+t}}catch(e){}}defineSelf(t){let i=new e({game:this.game,x:17.5,y:-10,text:t,style:{font:'14px Arial, "Noto Sans TC", "Microsoft JhengHei", sans-serif',fill:"#FFFFFF",stroke:"#000000",strokeThickness:3}});this.addChild(i)}}class k extends Phaser.Sprite{constructor(e,t,i,s,a={}){super(e,i*d+17.5,s*d+17.5,"bomb_tileset"),this.kind=a&&a.kind?a.kind:"normal",a&&a.mine&&(this.kind="mine"),this.power=a&&"number"==typeof a.power?a.power:null,"sky"===this.kind?this.tint=16733508:"remote"===this.kind?this.tint=6737151:"disease"===this.kind?this.tint=5635925:"mine"===this.kind&&(this.tint=16755285);try{(null==this.power?1:this.power)>=4&&(this.scale.setTo(.85),this._big=!0)}catch(e){}try{const e=(e,t)=>{const i=this.game.add.text(0,0,e,t);return i.anchor.setTo(.5),i.x=0,i.y=-2,this.addChild(i),i};"remote"===this.kind&&e("R",{font:"14px Arial",fill:"#ffffff",stroke:"#000000",strokeThickness:3}),"sky"===this.kind&&e("!",{font:"16px Arial",fill:"#ffffff",stroke:"#000000",strokeThickness:3}),"disease"===this.kind&&e("â˜ ",{font:"14px Arial",fill:"#ffffff",stroke:"#000000",strokeThickness:3}),"mine"===this.kind&&e("M",{font:"14px Arial",fill:"#000000",stroke:"#ffffff",strokeThickness:3}),this._big&&e("P",{font:"12px Arial",fill:"#ffffff",stroke:"#000000",strokeThickness:3})}catch(e){}this._kickedArrow=null,this.setKicked=e=>{try{this._kickedArrow&&(this._kickedArrow.destroy(),this._kickedArrow=null);const t={left:"â†",right:"â†’",up:"â†‘",down:"â†“"}[e]||"â†’",i=this.game.add.text(0,0,t,{font:"18px Arial",fill:"#ffffff",stroke:"#000000",strokeThickness:3});i.anchor.setTo(.5),i.x=0,i.y=14,this.addChild(i),this._kickedArrow=i,this.game.time.events.add(900,()=>{try{this._kickedArrow&&(this._kickedArrow.destroy(),this._kickedArrow=null)}catch(e){}})}catch(e){}};try{a&&a.kicked&&a.dir&&this.setKicked(a.dir)}catch(e){}this.scale.setTo(.7),this.anchor.setTo(.5),this.game=e,this.id=t,this.game.physics.arcade.enable(this),this.game.add.tween(this.scale).to({x:1.2,y:1.2},2e3,Phaser.Easing.Linear.None,!0),this.body.immovable=!0,this.animations.add("bomb",[0,1,2,3,4,5,6,7,8,9,10,11,12,13],6,!0),this.animations.play("bomb")}update(){}}class T extends Phaser.Sprite{constructor(e,t){let i=0;if(0===t.spoil_type&&(i=0),1===t.spoil_type&&(i=1),2===t.spoil_type&&(i=2),3===t.spoil_type&&(i=3),4===t.spoil_type&&(i=4),5===t.spoil_type&&(i=5),6===t.spoil_type&&(i=6),7===t.spoil_type&&(i=2),8===t.spoil_type&&(i=1),9===t.spoil_type&&(i=3),10===t.spoil_type&&(i=2),11===t.spoil_type&&(i=1),12===t.spoil_type&&(i=4),13===t.spoil_type&&(i=0),14===t.spoil_type&&(i=2),15===t.spoil_type&&(i=5),super(e,t.col*d,t.row*d,"spoil_tileset",i),7===t.spoil_type){this.tint=5635840;try{const e=this.game.add.sprite(0,0,"disease_icon");e.width=35,e.height=35,e.anchor.setTo(0,0),this.addChild(e)}catch(e){}}if(8===t.spoil_type){this.tint=16739286;try{const e=this.game.add.text(6,4,"+1",{font:"16px Arial",fill:"#ffffff",stroke:"#000000",strokeThickness:3});this.addChild(e)}catch(e){}}if(9===t.spoil_type){this.tint=58879;try{const e=this.game.add.text(3,6,"PW",{font:"14px Arial",fill:"#ffffff",stroke:"#000000",strokeThickness:3});this.addChild(e)}catch(e){}}if(10===t.spoil_type){this.tint=16759552;try{const e=this.game.add.text(10,6,"R",{font:"16px Arial",fill:"#000000",stroke:"#ffffff",strokeThickness:3});this.addChild(e)}catch(e){}}if(11===t.spoil_type){this.tint=16739286;try{const e=this.game.add.text(2,6,"+B",{font:"14px Arial",fill:"#ffffff",stroke:"#000000",strokeThickness:3});this.addChild(e)}catch(e){}}if(12===t.spoil_type){this.tint=6737151;try{const e=this.game.add.text(2,6,"BP",{font:"14px Arial",fill:"#ffffff",stroke:"#000000",strokeThickness:3});this.addChild(e)}catch(e){}}if(13===t.spoil_type){this.tint=6988799;try{const e=this.game.add.text(10,6,"S",{font:"16px Arial",fill:"#ffffff",stroke:"#000000",strokeThickness:3});this.addChild(e)}catch(e){}}if(14===t.spoil_type){this.tint=16777215;try{const e=this.game.add.text(10,6,"?",{font:"16px Arial",fill:"#000000",stroke:"#ffffff",strokeThickness:3});this.addChild(e)}catch(e){}}if(15===t.spoil_type){this.tint=16755285;try{const e=this.game.add.text(8,6,"M",{font:"16px Arial",fill:"#000000",stroke:"#ffffff",strokeThickness:3});this.addChild(e)}catch(e){}}this.id=t.id,this.game.physics.arcade.enable(this),this.alpha=.92,this.scale.setTo(1);try{const e=this.game.add.tween(this).to({alpha:.62},420,Phaser.Easing.Sinusoidal.InOut,!0,0,-1,!0),t=this.game.add.tween(this.scale).to({x:1.08,y:1.08},520,Phaser.Easing.Sinusoidal.InOut,!0,0,-1,!0);this._glowTween=e,this._scaleTween=t}catch(e){}}}class v extends Phaser.Sprite{constructor(e,t){super(e,t.col*d,t.row*d,t.type,0),this.game=e,this.animations.add("blast",[0,1,2,3,4]),this.play("blast",15,!1,!0),this.game.physics.arcade.enable(this)}}class P extends Phaser.Sprite{constructor(e,t,i){super(e,t*d,i*d,"bone_tileset")}}class S extends Phaser.State{init(e){this.currentGame=e}create(){this.createMap(),this.createPlayers(),this.setEventHandlers(),this.player&&this.game.camera.follow(this.player);try{window.UK01Pending&&window.UK01Pending.hide&&window.UK01Pending.hide()}catch(e){}try{window.UK01Menu&&window.UK01Menu.hideMenu&&window.UK01Menu.hideMenu()}catch(e){}try{window.UK01Touch&&window.UK01Touch.show&&window.UK01Touch.show()}catch(e){}this.sfxPortal=this.game.add.audio("sfx_portal"),this.sfxSpeed=this.game.add.audio("sfx_speed"),this.sfxExplosion=this.game.add.audio("sfx_explosion"),this.sfxDeath=this.game.add.audio("sfx_death");try{this.game._bgm&&this.game._bgm.stop&&this.game._bgm.stop(),this.game._bgm=this.game.add.audio("bgm_main"),this.game._bgm.loop=!0,this.game._bgm.volume=.28,this.game._bgm.play()}catch(e){}this.game.time.events.loop(400,this.stopAnimationLoop.bind(this))}update(){this.player&&this.darkness&&(this.darkness.x=this.player.x,this.darkness.y=this.player.y,this.game.world.bringToTop(this.darkness),this.game.world.bringToTop(this.spoils),this.game.world.bringToTop(this.bombs),this.game.world.bringToTop(this.bones),this.game.world.bringToTop(this.blasts),this.game.world.bringToTop(this.enemies),this.player&&this.game.world.bringToTop(this.player)),this.refreshGhostCollision(),this.game.physics.arcade.collide(this.player,this.blockLayer),this.game.physics.arcade.collide(this.player,this.enemies),this.game.physics.arcade.collide(this.player,this.bombs,this.onPlayerVsBomb,(e,t)=>{try{if(e&&e.hasBombPass)return!1;if(t&&"mine"===t.kind)return!1}catch(e){}return!0},this),this.game.physics.arcade.overlap(this.player,this.spoils,this.onPlayerVsSpoil,null,this),this.game.physics.arcade.overlap(this.player,this.blasts,this.onPlayerVsBlast,null,this),this.handleSpecialTiles()}createMap(){if(this.map=this.add.tilemap(this.currentGame.map_name),this.map.addTilesetImage("tiles"),this.blockLayer=this.map.createLayer(m),!this.blockLayer){try{console.warn("createLayer failed for",m,"falling back to layer 0")}catch(e){}this.blockLayer=this.map.createLayer(0)}if(!this.blockLayer)throw new Error("Tilemap layer not found: "+String(m));this.blockLayer.resizeWorld(),this.baseCollisionTiles=(this.blockLayer.layer.properties.collisionTiles||[]).slice(),this.wallTileIndex=this.blockLayer.layer.properties.wall,this.balkTileIndex=this.blockLayer.layer.properties.balk,this.map.setCollision(this.baseCollisionTiles,!0,this.blockLayer),this._ghostCollisionEnabled=!1,this.portalCells=[],this.speedCells=new Set,this.specialFx=this.game.add.group();const e=this.map.layers[0],t=e.width,i=e.height,s=e.data;for(let e=0;e<i;e++)for(let i=0;i<t;i++){const t=s[e][i];if(!t)continue;const a=t.index;2===a&&a!==this.balkTileIndex?this.portalCells.push({col:i,row:e}):3===a&&this.speedCells.add(`${i},${e}`)}for(const e of this.portalCells){const t=e.col*d,i=e.row*d,s=this.game.add.sprite(t,i,"portal_fx");s.alpha=.95,s.blendMode=Phaser.blendModes.ADD,s.animations.add("spin",[0,1,2,3,4,5],10,!0),s.animations.play("spin"),this.specialFx.add(s)}for(const e of this.speedCells){const[t,i]=e.split(",").map(Number),s=t*d,a=i*d,o=this.game.add.sprite(s,a,"speed_fx");o.alpha=.75,o.animations.add("flow",[0,1,2,3,4,5],12,!0),o.animations.play("flow"),this.specialFx.add(o)}this.player=null,this.bones=this.game.add.group(),this.bombs=this.game.add.group(),this.spoils=this.game.add.group(),this.blasts=this.game.add.group(),this.enemies=this.game.add.group(),this.game.physics.arcade.enable(this.blockLayer),this.darkness=null;try{"undefined"!=typeof window&&window.location&&/(?:\?|&)dark=1(?:&|$)/.test(window.location.search||"")&&(this.darkness=this.game.add.sprite(0,0,"light_mask"),this.darkness.anchor.setTo(.5),this.darkness.width=1600,this.darkness.height=1600,this.darkness.alpha=.82,this.darkness.blendMode=Phaser.blendModes.MULTIPLY)}catch(e){}}createPlayers(){const e=Object.values(this.currentGame.players||{});let t=e.find(e=>e&&e.id===clientSocket.id);if(!t)try{const i=window.currentUser&&window.currentUser.id;i&&(t=e.find(e=>e&&e.userId&&e.userId===i))}catch(e){}for(let i of e){if(!i)continue;let e={game:this.game,id:i.id,spawn:i.spawn,skin:i.skin,displayName:i.displayName||i.skin,avatarParts:i.avatarParts||null};t&&i===t||i.id===clientSocket.id?this.player=new b(e):this.enemies.add(new x(e))}if(!this.player&&e.length){const t=e.find(e=>e&&!("string"==typeof e.id&&e.id.startsWith("bot:")))||e[0];t&&(this.player=new b({game:this.game,id:t.id,spawn:t.spawn,skin:t.skin,avatarParts:t.avatarParts||null}))}}setEventHandlers(){clientSocket.on("move player",this.onMovePlayer.bind(this)),clientSocket.on("player win",this.onPlayerWin.bind(this)),clientSocket.on("show bomb",this.onShowBomb.bind(this)),clientSocket.on("detonate bomb",this.onDetonateBomb.bind(this)),clientSocket.on("move bomb",this.onMoveBomb.bind(this)),clientSocket.on("spoil was picked",this.onSpoilWasPicked.bind(this)),clientSocket.on("show bones",this.onShowBones.bind(this)),clientSocket.on("player disconnect",this.onPlayerDisconnect.bind(this)),clientSocket.on("sudden death tiles",this.onSuddenDeathTiles.bind(this)),clientSocket.on("spawn player",this.onSpawnPlayer.bind(this)),clientSocket.on("match summary",this.onMatchSummary.bind(this)),clientSocket.on("player hit",this.onPlayerHit.bind(this))}onPlayerHit({player_id:e,lives:t}){const i=this.player&&this.player.id===e?this.player:u(e,this.enemies);if(!i)return;try{this.player&&this.player.id===e&&"number"==typeof t&&(this.player.lives=t,this.player.info&&this.player.info.refreshLives&&this.player.info.refreshLives())}catch(e){}i.flickerTimer&&this.game.time.events.remove(i.flickerTimer),i.alpha=1;let s=0;i.flickerTimer=this.game.time.events.loop(100,()=>{i.alpha=1===i.alpha?.3:1,s++,s>28&&(this.game.time.events.remove(i.flickerTimer),i.alpha=1)});try{this.sfxDeath&&this.sfxDeath.play()}catch(e){}}onPlayerVsSpoil(e,t){clientSocket.emit("pick up spoil",{spoil_id:t.id}),t.kill()}onPlayerVsBlast(e,t){if(!e.alive)return;if(e.isShielded&&e.isShielded())return;const i=this.game.time.now;e._lastDeathReport&&i-e._lastDeathReport<500||(e._lastDeathReport=i,clientSocket.emit("player died",{col:e.currentCol(),row:e.currentRow()}))}onMovePlayer({player_id:e,x:t,y:i}){let s=u(e,this.enemies);s&&s.goTo({x:t,y:i})}onPlayerVsBomb(e,t){if(!e||!t)return;if(!e.hasKick)return;const i=e.leftKey.isDown||e.aKey&&e.aKey.isDown||e.touchLeft,s=e.rightKey.isDown||e.dKey&&e.dKey.isDown||e.touchRight,a=e.upKey.isDown||e.wKey&&e.wKey.isDown||e.touchUp,o=e.downKey.isDown||e.sKey&&e.sKey.isDown||e.touchDown;let h=null;if(i?h="left":s?h="right":a?h="up":o&&(h="down"),!h)return;const n=this.game.time.now;e._lastKickAt||(e._lastKickAt=0),n-e._lastKickAt<110||(e._lastKickAt=n,clientSocket.emit("kick bomb",{bomb_id:t.id,dir:h}))}onMoveBomb({bomb_id:e,col:t,row:i,kicked:s,dir:a}){const o=u(e,this.bombs);if(!o)return;const h=t*d+17.5,n=i*d+17.5;o.x=h,o.y=n,o.body&&o.body.reset(h,n);try{s&&o.setKicked&&o.setKicked(a)}catch(e){}}stopAnimationLoop(){for(let e of this.enemies.children)e.lastMoveAt<this.game.time.now-200&&e.animations.stop()}createTouchControls(){if(!this.player)return;if(!(this.game.device&&(this.game.device.touch||this.game.device.iOS||this.game.device.android)||"undefined"!=typeof window&&"ontouchstart"in window||"undefined"!=typeof navigator&&navigator.maxTouchPoints>0))return;const e=this.game.add.group();e.fixedToCamera=!0,e.cameraOffset.setTo(0,0);const t=this.game.width,i=this.game.height,s=(()=>{try{const e=getComputedStyle(document.documentElement).getPropertyValue("env(safe-area-inset-bottom)"),t=parseInt((e||"0").toString().replace("px","").trim(),10);return Number.isFinite(t)?t:0}catch(e){return 0}})(),a=Math.max(28,s+18),o=Math.max(.85,Math.min(1.15,Math.min(t,i)/700)),h=125*o,n=i-185*o-a,l=70*o,r=36*o,d=this.game.add.graphics(0,0);d.beginFill(1118481,.22),d.lineStyle(3,16777215,.18),d.drawCircle(0,0,2*l),d.endFill(),d.x=h,d.y=n,d.inputEnabled=!0,d.input.enableDrag(!1),e.add(d);const m=this.game.add.graphics(0,0);m.beginFill(58879,.18),m.lineStyle(3,58879,.25),m.drawCircle(0,0,2*r),m.endFill(),m.x=h,m.y=n,e.add(m);const c=()=>{this.player.touchLeft=this.player.touchRight=this.player.touchUp=this.player.touchDown=!1},p=(e,t)=>{if(c(),Math.abs(e)<14&&Math.abs(t)<14)return m.x=h,void(m.y=n);Math.abs(e)>Math.abs(t)?(e>0?this.player.touchRight=!0:this.player.touchLeft=!0,m.x=h+Math.max(-l+r,Math.min(l-r,e)),m.y=n):(t>0?this.player.touchDown=!0:this.player.touchUp=!0,m.x=h,m.y=n+Math.max(-l+r,Math.min(l-r,t)))},g=e=>{const t=e.x-h,i=e.y-n,s=Math.sqrt(t*t+i*i)||1,a=l-r,o=Math.min(a,s);p(t/s*o,i/s*o)};d.events.onInputDown.add((e,t)=>g(t)),d.events.onInputUp.add(()=>{c(),m.x=h,m.y=n}),d.events.onInputOut.add(()=>{c(),m.x=h,m.y=n}),this.game.input.addMoveCallback(e=>{e.isDown&&g(e)},this),(({x:t,y:i,r:s=44,label:a,onDown:o,onUp:h,fill:n=1118481,alpha:l=.35,stroke:r=16777215,strokeAlpha:d=.22})=>{const m=this.game.add.graphics(0,0);m.beginFill(n,l),m.lineStyle(3,r,d),m.drawCircle(0,0,2*s),m.endFill(),m.x=t,m.y=i;const c=this.game.add.text(0,0,a,{font:"26px Arial",fill:"#ffffff"});c.anchor.setTo(.5),m.addChild(c),m.inputEnabled=!0,m.events.onInputDown.add(()=>o&&o());const p=()=>h&&h();m.events.onInputUp.add(p),m.events.onInputOut.add(p),e.add(m)})({x:t-115*o,y:i-165*o-a,r:54*o,label:"ðŸ’£",fill:8002815,alpha:.32,stroke:58879,strokeAlpha:.35,onDown:()=>this.player.touchBomb=!0,onUp:()=>this.player.touchBomb=!1}),this.game.scale.onSizeChange.add(()=>{this.game.width,this.game.height,e.destroy(!0),this.createTouchControls()})}onSuddenDeathTiles({level:e,tiles:t}){if(!t||!t.length)return;const i=this.wallTileIndex;for(const e of t)try{this.map.putTile(i,e.col,e.row,this.blockLayer)}catch(e){}try{this._sdText||(this._sdText=this.game.add.text(10,10,"",{font:"16px Arial",fill:"#ffdf7a",stroke:"#000",strokeThickness:3}),this._sdText.fixedToCamera=!0),this._sdText.text=`SUDDEN DEATH Lv.${e}`,this.game.time.events.add(1200,()=>{try{this._sdText&&(this._sdText.text="")}catch(e){}})}catch(e){}}refreshGhostCollision(){if(!this.player)return;const e=this.player.isGhosted&&this.player.isGhosted()||this.player.isPassWalled&&this.player.isPassWalled();e!==this._ghostCollisionEnabled&&(this._ghostCollisionEnabled=e,e?(this.map.setCollision([this.wallTileIndex],!0,this.blockLayer),null!=this.balkTileIndex&&this.map.setCollision([this.balkTileIndex],!1,this.blockLayer)):this.map.setCollision(this.baseCollisionTiles,!0,this.blockLayer))}handleSpecialTiles(){if(!this.player)return;const e=Math.floor(this.player.body.position.x/d),t=Math.floor(this.player.body.position.y/d),i=this.speedCells.has(`${e},${t}`);if(this.player.tileSpeedMultiplier=i?1.65:1,this.player._wasOnSpeed||(this.player._wasOnSpeed=!1),i&&!this.player._wasOnSpeed)try{this.sfxSpeed&&this.sfxSpeed.play()}catch(e){}if(this.player._wasOnSpeed=i,this.portalCells.length>=2){const i=this.game.time.now;this.player._lastPortalAt||(this.player._lastPortalAt=0);const s=(e,t)=>{try{const i=this.map.getTile(e,t,this.blockLayer);return!!i&&(i.index===this.wallTileIndex||null!=this.balkTileIndex&&i.index===this.balkTileIndex||!!i.collides)}catch(e){return!1}},a=(e,t)=>{try{return(this.bombs&&this.bombs.children||[]).some(i=>i&&i.col===e&&i.row===t)}catch(e){return!1}},o=(e,t)=>{const i=(e,t)=>s(e,t)||a(e,t)?null:{col:e,row:t};let o=i(e,t);if(o)return o;for(let s=1;s<=2;s++)for(let a=-s;a<=s;a++)for(let h=-s;h<=s;h++)if(o=i(e+h,t+a),o)return o;return null},h=this.portalCells.findIndex(i=>i.col===e&&i.row===t);if(h>=0&&i-this.player._lastPortalAt>950){const e=h%2==0?h+1:h-1,t=this.portalCells[e];if(t){const e=o(t.col,t.row);if(e){this.player.x=e.col*d,this.player.y=e.row*d,this.player.body.velocity.set(0),this.player.body.reset(this.player.x,this.player.y),this.player.prevPosition={x:this.player.x,y:this.player.y},this.player._lastPortalAt=i;try{this.sfxPortal&&this.sfxPortal.play()}catch(e){}}}}}}onShowBomb({bomb_id:e,col:t,row:i,kind:s,owner_id:a,power:o,kicked:h,dir:n}){this.bombs.add(new k(this.game,e,t,i,{kind:s,owner_id:a,power:o,kicked:h,dir:n}))}onDetonateBomb({bomb_id:e,blastedCells:t}){_(e,this.bombs);try{this.sfxExplosion&&this.sfxExplosion.play()}catch(e){}for(let e of t)this.blasts.add(new v(this.game,e));for(let e of t)e.destroyed&&this.map.putTile(this.blockLayer.layer.properties.empty,e.col,e.row,this.blockLayer);for(let e of t)e.destroyed&&e.spoil&&this.spoils.add(new T(this.game,e.spoil))}onSpoilWasPicked({player_id:e,spoil_id:t,spoil_type:i}){e===this.player.id&&this.player.pickSpoil(i),_(t,this.spoils)}onShowBones({player_id:e,col:t,row:i}){this.bones.add(new P(this.game,t,i)),_(e,this.enemies)}onMatchSummary({summary:e,reason:t}){try{window.UK01Touch&&window.UK01Touch.hide&&window.UK01Touch.hide()}catch(e){}try{clientSocket.emit("leave game")}catch(e){}this.state.start("Win",!0,!1,{mode:"horde",summary:e,reason:t||"horde_end"})}onPlayerWin(e){try{window.UK01Touch&&window.UK01Touch.hide&&window.UK01Touch.hide()}catch(e){}clientSocket.emit("leave game");const t=e&&e.skin?e.skin:e,i=e&&e.reason?e.reason:null;this.state.start("Win",!0,!1,{skin:t,reason:i})}onPlayerDisconnect({player_id:e}){_(e,this.enemies),this.enemies.children.length>=1||this.onPlayerWin()}onSpawnPlayer({player:e}){try{if(!e||!e.id)return;if(e.id===clientSocket.id)return;if(u(e.id,this.enemies))return;const t={game:this.game,id:e.id,spawn:e.spawn,skin:e.skin,displayName:e.displayName||e.skin,avatarParts:e.avatarParts||null};this.enemies.add(new x(t))}catch(e){}}}const K=S;class M extends Phaser.State{init(e){e&&"object"==typeof e?(this.skin=e.skin,this.reason=e.reason,this.summary=e.summary||null,this.mode=e.mode||null):(this.skin=e,this.reason=null,this.summary=null,this.mode=null)}create(){try{window.UK01Touch&&window.UK01Touch.hide&&window.UK01Touch.hide()}catch(e){}try{const e=this.game;e&&e._bgm&&e._bgm.stop&&e._bgm.stop()}catch(e){}new e({game:this.game,x:this.game.world.centerX,y:this.game.world.centerY,text:this.winnerText(),style:{font:'30px Arial, "Noto Sans TC", "Microsoft JhengHei", sans-serif',fill:"#FFFFFF"}});try{this.game.input.onTap.addOnce(()=>this.returnToMenu())}catch(e){}try{this.game.input.onDown.addOnce(()=>this.returnToMenu())}catch(e){}try{this.game.time.events.add(3500,()=>this.returnToMenu())}catch(e){}}update(){this.game.input.keyboard.isDown(Phaser.Keyboard.ENTER)&&this.returnToMenu()}returnToMenu(){this.state.start("Menu")}winnerText(){if(this.summary&&("horde"===this.summary.mode||"horde"===this.mode)){const e=this.summary,t=null!=e.durationMs?(e.durationMs/1e3).toFixed(1):null,i=null!=e.teamKills?e.teamKills:0,s=e.perPlayer&&e.perPlayer[0]?e.perPlayer[0]:null;return`HORDE ended. Time: ${t||"?"}s  Team Kills: ${i}\n${s?`${s.displayName||s.skin}: ${(s.survivalMs/1e3).toFixed(1)}s, ${s.kills} kills`:""}\nTap to return to main menu.`}if(this.skin){const e=this.reason?` (reason: ${this.reason})`:"";return`Player: "${this.skin}" won!${e} Tap to return to main menu.`}return"Opponent left! Tap to return to main menu."}}const C=M;class U extends Phaser.Game{constructor(){super(980,630,Phaser.AUTO,"game-container"),this.config.forceSetTimeOut=!0,this.state.add("Boot",o),this.state.add("Preload",n),this.state.add("Menu",r),this.state.add("SelectMap",g),this.state.add("PendingGame",f),this.state.add("Play",K),this.state.add("Win",C),this.state.start("Boot")}}window.__phaserGame=new U})();
//# sourceMappingURL=bundle.e801afca1e7ded0ae02b.js.map