(()=>{"use strict";class e extends Phaser.Text{constructor({game:e,x:t,y:s,text:i,style:a}){super(e,t,s,i,a),this.anchor.setTo(.5),this.game.add.existing(this)}}class t extends Phaser.Button{constructor({game:e,x:t,y:s,asset:i,callback:a,callbackContext:o,overFrame:h,outFrame:n,downFrame:l,upFrame:r}){super(e,t,s,i,a,o,h,n,l,r),this.anchor.setTo(.5),this.game.add.existing(this)}}class s extends Phaser.Button{constructor({game:e,x:t,y:s,asset:i,callback:a,callbackContext:o,overFrame:h,outFrame:n,downFrame:l,upFrame:r,label:m,style:d}){super(e,t,s,i,a,o,h,n,l,r),this.anchor.setTo(.5),this.text=new Phaser.Text(this.game,0,0,m,d),this.text.anchor.setTo(.5),this.addChild(this.text),this.game.add.existing(this)}disable(){this.setFrames(3,3),this.inputEnabled=!1,this.input.useHandCursor=!1}enable(){this.setFrames(1,0,2),this.inputEnabled=!0,this.input.useHandCursor=!0}}class i extends Phaser.Group{constructor({game:e,availableGames:t,callback:s,callbackContext:i,x:a,y:o,style:h}){super(e);let n=o;for(let e of t){let t=new Phaser.Image(this.game,a,n,"slot_backdrop"),o=new Phaser.Button(this.game,t.width-100,12,"list_icon",s.bind(i,{game_id:e.id}),null,1,0,2,1),l=new Phaser.Text(this.game,30,25,`Join Game: ${e.name}`,h);t.addChild(o),t.addChild(l),this.add(t),n+=105}}destroy(){this.callAll("kill")}}class a extends Phaser.Group{constructor({game:e,max_players:t,players:s,x:i,y:a,asset_empty:o,asset_player:h,style:n}){super(e);let l=i;for(let e=0;e<t;e++){let t,i,r=s[e];r?(t=new Phaser.Image(this.game,l,a,h+r.skin),i=new Phaser.Text(this.game,t.width/2,t.height+15,r.skin,n),i.anchor.setTo(.5),t.addChild(i)):t=new Phaser.Image(this.game,l,a,o),this.add(t),l+=170}}destroy(){this.callAll("kill")}}class o extends Phaser.Group{constructor({game:e,asset:t,x:s,y:i}){super(e),this.picture=new Phaser.Image(this.game,s,i-20,t),this.picture.anchor.setTo(.5),this.add(this.picture),this.tween=this.game.add.tween(this.picture),this.tween.to({y:this.picture.y-25,alpha:0},600),this.tween.onComplete.add(this.finish,this),this.tween.start()}finish(){this.callAll("kill")}}class h extends Phaser.State{create(){this.game.stage.disableVisibilityChange=!0,this.game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.game.scale.pageAlignHorizontally=!0,this.game.scale.pageAlignVertically=!0;const t=()=>{try{this.game.scale.refresh()}catch(e){}};window.addEventListener("resize",t),t(),new e({game:this.game,x:this.game.world.centerX,y:this.game.world.centerY,text:"Loading...",style:{font:"30px Areal",fill:"#FFFFFF"}}),this.state.start("Preload")}}const n=h;class l extends Phaser.State{preload(){this.load.image("main_menu","images/menu/main_menu.png"),this.load.image("slot_backdrop","images/menu/slot_backdrop.png"),this.load.spritesheet("buttons","images/menu/buttons.png",200,75),this.load.spritesheet("check_icon","images/menu/accepts.png",75,75),this.load.spritesheet("list_icon","images/menu/game_enter.png",75,75),this.load.image("hot_map_preview","images/menu/hot_map_preview.png"),this.load.image("cold_map_preview","images/menu/cold_map_preview.png"),this.load.image("arena_map_preview","images/menu/arena_map_preview.png?v=2"),this.load.image("open_map_preview","images/menu/open_map_preview.png?v=3"),this.load.image("rune_lab_preview","images/menu/rune_lab_preview.png?v=1"),this.load.image("mirror_temple_preview","images/menu/mirror_temple_preview.png?v=1"),this.load.image("trap_garden_preview","images/menu/trap_garden_preview.png?v=1"),this.load.image("prev","images/menu/left_arrow.png"),this.load.image("next","images/menu/right_arrow.png"),this.load.image("tiles","maps/tileset.png"),this.load.tilemap("hot_map","maps/hot_map.json",null,Phaser.Tilemap.TILED_JSON),this.load.tilemap("cold_map","maps/cold_map.json",null,Phaser.Tilemap.TILED_JSON),this.load.tilemap("arena_map","maps/arena_map.json",null,Phaser.Tilemap.TILED_JSON),this.load.tilemap("open_map","maps/open_map.json",null,Phaser.Tilemap.TILED_JSON),this.load.tilemap("rune_lab","maps/rune_lab.json",null,Phaser.Tilemap.TILED_JSON),this.load.tilemap("mirror_temple","maps/mirror_temple.json",null,Phaser.Tilemap.TILED_JSON),this.load.tilemap("trap_garden","maps/trap_garden.json",null,Phaser.Tilemap.TILED_JSON),this.load.spritesheet("explosion_center","images/game/explosion_center.png",35,35),this.load.spritesheet("explosion_horizontal","images/game/explosion_horizontal.png",35,35),this.load.spritesheet("explosion_vertical","images/game/explosion_vertical.png",35,35),this.load.spritesheet("explosion_up","images/game/explosion_up.png",35,35),this.load.spritesheet("explosion_right","images/game/explosion_right.png",35,35),this.load.spritesheet("explosion_down","images/game/explosion_down.png",35,35),this.load.spritesheet("explosion_left","images/game/explosion_left.png",35,35),this.load.spritesheet("spoil_tileset","images/game/spoil_tileset.png",35,35),this.load.spritesheet("bone_tileset","images/game/bone_tileset.png",35,35),this.load.spritesheet("bomb_tileset","images/game/bombs.png",35,35),this.load.image("speed_up_bonus","images/game/speed_up_bonus.png"),this.load.image("speed_up_no_bonus","images/game/speed_up_no_bonus.png"),this.load.image("delay_up_bonus","images/game/delay_up_bonus.png"),this.load.image("delay_up_no_bonus","images/game/delay_up_no_bonus.png"),this.load.image("power_up_bonus","images/game/power_up_bonus.png"),this.load.image("placeholder_power","images/game/placeholder_power.png"),this.load.image("placeholder_speed","images/game/placeholder_speed.png"),this.load.image("placeholder_time","images/game/placeholder_time.png"),this.load.spritesheet("portal_fx","images/game/portal_fx.png",35,35),this.load.spritesheet("speed_fx","images/game/speed_fx.png",35,35),this.load.image("ghost_icon","images/game/ghost_icon.png"),this.load.audio("sfx_portal",["sfx/portal.wav"]),this.load.audio("sfx_speed",["sfx/speed.wav"]),this.load.image("bomberman_head_blank","images/game/chars/0-face.png"),this.load.image("bomberman_head_Theodora","images/game/chars/1-face.png"),this.load.image("bomberman_head_Ringo","images/game/chars/2-face.png"),this.load.image("bomberman_head_Jeniffer","images/game/chars/3-face.png"),this.load.image("bomberman_head_Godard","images/game/chars/4-face.png"),this.load.image("bomberman_head_Biarid","images/game/chars/5-face.png"),this.load.image("bomberman_head_Solia","images/game/chars/6-face.png"),this.load.image("bomberman_head_Kedan","images/game/chars/7-face.png"),this.load.image("bomberman_head_Nigob","images/game/chars/8-face.png"),this.load.image("bomberman_head_Baradir","images/game/chars/9-face.png"),this.load.image("bomberman_head_Raviel","images/game/chars/10-face.png"),this.load.image("bomberman_head_Valpo","images/game/chars/11-face.png"),this.load.spritesheet("bomberman_Theodora","images/game/chars/1-preview.png",32,32),this.load.spritesheet("bomberman_Ringo","images/game/chars/2-preview.png",32,32),this.load.spritesheet("bomberman_Jeniffer","images/game/chars/3-preview.png",32,32),this.load.spritesheet("bomberman_Godard","images/game/chars/4-preview.png",32,32),this.load.spritesheet("bomberman_Biarid","images/game/chars/5-preview.png",32,32),this.load.spritesheet("bomberman_Solia","images/game/chars/6-preview.png",32,32),this.load.spritesheet("bomberman_Kedan","images/game/chars/7-preview.png",32,32),this.load.spritesheet("bomberman_Nigob","images/game/chars/8-preview.png",32,32),this.load.spritesheet("bomberman_Baradir","images/game/chars/9-preview.png",32,32),this.load.spritesheet("bomberman_Raviel","images/game/chars/10-preview.png",32,32),this.load.spritesheet("bomberman_Valpo","images/game/chars/11-preview.png",32,32)}create(){this.state.start("Menu")}}const r=l;class m extends Phaser.State{init(){this.slotsWithGame=null,clientSocket.on("display pending games",this.displayPendingGames.bind(this))}create(){this.add.image(this.game.world.centerX,this.game.world.centerY,"main_menu").anchor.setTo(.5),new e({game:this.game,x:this.game.world.centerX,y:this.game.world.centerY-215,text:"Main Menu",style:{font:"35px Areal",fill:"#9ec0ba",stroke:"#7f9995",strokeThickness:3}}),new s({game:this.game,x:this.game.world.centerX,y:this.game.world.centerY+195,asset:"buttons",callback:this.hostGameAction,callbackContext:this,overFrame:1,outFrame:0,downFrame:2,upFrame:0,label:"New Game",style:{font:"20px Areal",fill:"#000000"}}),clientSocket.emit("enter lobby",this.displayPendingGames.bind(this))}update(){}hostGameAction(){clientSocket.emit("leave lobby"),this.state.start("SelectMap")}displayPendingGames(e){this.slotsWithGame&&this.slotsWithGame.destroy(),this.slotsWithGame=new i({game:this.game,availableGames:e,callback:this.joinGameAction,callbackContext:this,x:this.game.world.centerX-220,y:160,style:{font:"35px Areal",fill:"#efefef",stroke:"#ae743a",strokeThickness:3}})}joinGameAction(e){clientSocket.emit("leave lobby"),this.state.start("PendingGame",!0,!1,e)}}const d=m,p=["hot_map","cold_map","arena_map","open_map","rune_lab","mirror_temple","trap_garden"],c=35;class g extends Phaser.State{init(){this.slider=new phaseSlider(this)}create(){this.add.image(this.game.world.centerX,this.game.world.centerY,"main_menu").anchor.setTo(.5),new e({game:this.game,x:this.game.world.centerX,y:this.game.world.centerY-215,text:"Select Map",style:{font:"35px Areal",fill:"#9ec0ba",stroke:"#6f7975",strokeThickness:3}});let s=new Phaser.Image(this.game,0,0,"hot_map_preview"),i=new Phaser.Image(this.game,0,0,"cold_map_preview"),a=new Phaser.Image(this.game,0,0,"arena_map_preview"),o=new Phaser.Image(this.game,0,0,"open_map_preview"),h=new Phaser.Image(this.game,0,0,"rune_lab_preview"),n=new Phaser.Image(this.game,0,0,"mirror_temple_preview"),l=new Phaser.Image(this.game,0,0,"trap_garden_preview");this.slider.createSlider({x:this.game.world.centerX-s.width/2,y:this.game.world.centerY-i.height/2,width:s.width,height:s.height,customHandlePrev:"prev",customHandleNext:"next",objects:[s,i,a,o,h,n,l]}),new t({game:this.game,x:this.game.world.centerX,y:this.game.world.centerY+195,asset:"check_icon",callback:this.confirmStageSelection,callbackContext:this,overFrame:1,outFrame:0,downFrame:2,upFrame:0})}confirmStageSelection(){let e=p[this.slider.getCurrentIndex()];clientSocket.emit("create game",e,this.joinToNewGame.bind(this))}joinToNewGame(e){if(e&&e.error)return void alert(e.message||e.error);const t=e&&e.game_id?e.game_id:e;this.state.start("PendingGame",!0,!1,t)}}const y=g;class u extends Phaser.State{init(e){this.slotsWithPlayer=null,this.game_id=e&&e.game_id?e.game_id:e,clientSocket.on("update game",this.displayGameInfo.bind(this)),clientSocket.on("launch game",this.launchGame.bind(this)),clientSocket.emit("enter pending game",{game_id:this.game_id})}create(){this.add.image(this.game.world.centerX,this.game.world.centerY,"main_menu").anchor.setTo(.5),this.gameTitle=new e({game:this.game,x:this.game.world.centerX,y:this.game.world.centerY-215,text:"",style:{font:"35px Areal",fill:"#9ec0ba",stroke:"#6f7975",strokeThickness:3}}),this.startGameButton=new s({game:this.game,x:this.game.world.centerX+105,y:this.game.world.centerY+195,asset:"buttons",callback:this.startGameAction,callbackContext:this,overFrame:1,outFrame:0,downFrame:2,upFrame:0,label:"Start Game",style:{font:"20px Areal",fill:"#000000"}}),this.startGameButton.disable(),this.aiCount=3,this.aiText=new e({game:this.game,x:this.game.world.centerX,y:this.game.world.centerY+100,text:`AI: ${this.aiCount}`,style:{font:"24px Areal",fill:"#ffffff",stroke:"#000000",strokeThickness:3}}),this.aiDifficulty="normal";const t=this.game.world.centerY+40;this.aiDiffText=new e({game:this.game,x:this.game.world.centerX,y:t,text:`é›£åº¦: ${this.aiDifficulty}`,style:{font:"22px Areal",fill:"#ffffff",stroke:"#000000",strokeThickness:3}}),this.aiEasy=new s({game:this.game,x:this.game.world.centerX-230,y:t,asset:"buttons",callback:()=>this.setAIDifficulty("easy"),callbackContext:this,overFrame:1,outFrame:0,downFrame:2,upFrame:0,label:"Easy",style:{font:"20px Areal",fill:"#000000"}}),this.aiNormal=new s({game:this.game,x:this.game.world.centerX,y:t,asset:"buttons",callback:()=>this.setAIDifficulty("normal"),callbackContext:this,overFrame:1,outFrame:0,downFrame:2,upFrame:0,label:"Normal",style:{font:"18px Areal",fill:"#000000"}}),this.aiHard=new s({game:this.game,x:this.game.world.centerX+230,y:t,asset:"buttons",callback:()=>this.setAIDifficulty("hard"),callbackContext:this,overFrame:1,outFrame:0,downFrame:2,upFrame:0,label:"Hard",style:{font:"20px Areal",fill:"#000000"}}),this.aiMinus=new s({game:this.game,x:this.game.world.centerX-120,y:this.game.world.centerY+120,asset:"buttons",callback:()=>this.setAICount(this.aiCount-1),callbackContext:this,overFrame:1,outFrame:0,downFrame:2,upFrame:0,label:"-",style:{font:"34px Areal",fill:"#000000"}}),this.aiPlus=new s({game:this.game,x:this.game.world.centerX+120,y:this.game.world.centerY+120,asset:"buttons",callback:()=>this.setAICount(this.aiCount+1),callbackContext:this,overFrame:1,outFrame:0,downFrame:2,upFrame:0,label:"+",style:{font:"30px Areal",fill:"#000000"}}),new s({game:this.game,x:this.game.world.centerX-105,y:this.game.world.centerY+195,asset:"buttons",callback:this.leaveGameAction,callbackContext:this,overFrame:1,outFrame:0,downFrame:2,upFrame:0,label:"Leave Game",style:{font:"20px Areal",fill:"#000000"}})}setAICount(e){this.aiCount=Math.max(0,Math.min(3,e)),this.aiText&&(this.aiText.text=`AI: ${this.aiCount}`),clientSocket.emit("set ai count",{count:this.aiCount})}setAIDifficulty(e){this.aiDifficulty=e,this.aiDiffText&&(this.aiDiffText.text=`é›£åº¦: ${this.aiDifficulty}`),clientSocket.emit("set ai difficulty",{difficulty:this.aiDifficulty})}displayGameInfo({current_game:e}){let t=Object.values(e.players);this.gameTitle.text=e.name,this.slotsWithPlayer&&this.slotsWithPlayer.destroy(),this.slotsWithPlayer=new a({game:this.game,max_players:e.max_players,players:t,x:this.game.world.centerX-245,y:this.game.world.centerY-80,asset_empty:"bomberman_head_blank",asset_player:"bomberman_head_",style:{font:"20px Areal",fill:"#48291c"}}),t.length>=1?this.startGameButton.enable():this.startGameButton.disable()}leaveGameAction(){clientSocket.emit("leave pending game"),this.state.start("Menu")}startGameAction(){clientSocket.emit("start game")}launchGame(e){this.state.start("Play",!0,!1,e)}}const b=u,w=function(e,t){for(let s of t.children)if(s.id===e)return s;return null},_=function(e,t){let s=w(e,t);s&&s.destroy()};class f{constructor({game:e,player:t}){this.game=e,this.player=t,this.style={font:"14px Arial",fill:"#ffffff",align:"left"},this.redStyle={font:"30px Arial",fill:"#ff0044",align:"center"},this.hud=this.game.add.group(),this.hud.fixedToCamera=!0;let s=new Phaser.Image(this.game,5,2,"placeholder_speed");this.speedText=new Phaser.Text(this.game,35,7,this.speedLabel(),this.style),s.addChild(this.speedText),this.hud.add(s);let i=new Phaser.Image(this.game,110,2,"placeholder_power");this.powerText=new Phaser.Text(this.game,35,7,this.powerLabel(),this.style),i.addChild(this.powerText),this.hud.add(i);let a=new Phaser.Image(this.game,215,2,"placeholder_time");this.delayText=new Phaser.Text(this.game,35,7,this.delayLabel(),this.style),a.addChild(this.delayText),this.hud.add(a);let o=new Phaser.Image(this.game,320,2,"ghost_icon");o.alpha=.85,this.ghostText=new Phaser.Text(this.game,35,7,"",this.style),o.addChild(this.ghostText),o.visible=!1,this.ghostIcon=o,this.hud.add(o),this._ghostTimer=null,this.deadText=this.game.add.text(this.game.world.centerX,this.game.world.height-30,"You died :(",this.redStyle),this.deadText.anchor.set(.5),this.deadText.visible=!1,this.deadText.fixedToCamera=!0}refreshStatistic(){this.speedText.text=this.speedLabel(),this.powerText.text=this.powerLabel(),this.delayText.text=this.delayLabel()}showGhost(e){if(!this.ghostIcon)return;if(this.ghostIcon.visible=!0,this._ghostTimer){try{this.game.time.events.remove(this._ghostTimer)}catch(e){}this._ghostTimer=null}const t=()=>{const t=Math.max(0,e-this.game.time.now);this.ghostText.text=`${(t/1e3).toFixed(1)}s`,t<=0&&this.hideGhost()};t(),this._ghostTimer=this.game.time.events.loop(150,t)}hideGhost(){if(this.ghostIcon&&(this.ghostIcon.visible=!1),this._ghostTimer){try{this.game.time.events.remove(this._ghostTimer)}catch(e){}this._ghostTimer=null}}showDeadInfo(){this.deadText.visible=!0}speedLabel(){return this.player.speed}powerLabel(){return`x ${this.player.power}`}delayLabel(){return this.player.delay/1e3+" sec."}}class x extends Phaser.Sprite{constructor({game:e,id:t,spawn:s,skin:i}){super(e,s.x,s.y,"bomberman_"+i),this.game=e,this.id=t,this.prevPosition={x:s.x,y:s.y},this.delay=2e3,this.power=1,this.speed=150,this.tileSpeedMultiplier=1,this._lastBombTime=0,this.shieldUntil=0,this.ghostUntil=0,this.hasRemote=!1,this.hasKick=!1,this.game.add.existing(this),this.game.physics.arcade.enable(this),this.body.setSize(20,20,6,6),this.touchLeft=!1,this.touchRight=!1,this.touchUp=!1,this.touchDown=!1,this.touchBomb=!1,e.time.events.loop(100,this.positionUpdaterLoop.bind(this)),this.animations.add("up",[9,10,11],15,!0),this.animations.add("down",[0,1,2],15,!0),this.animations.add("right",[6,7,8],15,!0),this.animations.add("left",[3,4,5],15,!0),this.info=new f({game:this.game,player:this}),this.defineKeyboard(),this.defineSelf(i)}update(){this.alive&&(this.handleMoves(),this.handleBombs())}defineKeyboard(){this.upKey=this.game.input.keyboard.addKey(Phaser.Keyboard.UP),this.downKey=this.game.input.keyboard.addKey(Phaser.Keyboard.DOWN),this.leftKey=this.game.input.keyboard.addKey(Phaser.Keyboard.LEFT),this.rightKey=this.game.input.keyboard.addKey(Phaser.Keyboard.RIGHT),this.wKey=this.game.input.keyboard.addKey(Phaser.Keyboard.W),this.aKey=this.game.input.keyboard.addKey(Phaser.Keyboard.A),this.sKey=this.game.input.keyboard.addKey(Phaser.Keyboard.S),this.dKey=this.game.input.keyboard.addKey(Phaser.Keyboard.D),this.spaceKey=this.game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR)}handleMoves(){this.body.velocity.set(0);let e=[];const t=this.speed*(this.tileSpeedMultiplier||1),s=this.leftKey.isDown||this.aKey&&this.aKey.isDown||this.touchLeft,i=this.rightKey.isDown||this.dKey&&this.dKey.isDown||this.touchRight,a=this.upKey.isDown||this.wKey&&this.wKey.isDown||this.touchUp,o=this.downKey.isDown||this.sKey&&this.sKey.isDown||this.touchDown;s?(this.body.velocity.x=-t,e.push("left")):i&&(this.body.velocity.x=t,e.push("right")),a?(this.body.velocity.y=-t,e.push("up")):o&&(this.body.velocity.y=t,e.push("down"));let h=e[0];h?this.animations.play(h):this.animations.stop()}handleBombs(){if(this.game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR)||this.touchBomb){let e=this.game.time.now;e>this._lastBombTime&&(this._lastBombTime=e+this.delay,clientSocket.emit("create bomb",{col:this.currentCol(),row:this.currentRow()}))}}currentCol(){return Math.floor(this.body.position.x/c)}currentRow(){return Math.floor(this.body.position.y/c)}positionUpdaterLoop(){let e={x:this.position.x,y:this.position.y};this.prevPosition.x===e.x&&this.prevPosition.y===e.y||(clientSocket.emit("update player position",e),this.prevPosition=e)}becomesDead(){this.info.showDeadInfo(),this.kill()}pickSpoil(e){0===e&&this.increaseSpeed(),1===e&&this.increasePower(),2===e&&this.increaseDelay(),3===e&&this.activateShield(),4===e&&this.enableRemote(),5===e&&this.enableKick(),6===e&&this.activateGhost()}isShielded(){return this.shieldUntil&&this.game.time.now<this.shieldUntil}isGhosted(){return this.ghostUntil&&this.game.time.now<this.ghostUntil}increaseSpeed(){let e="speed_up_no_bonus";this.speed<350&&(this.speed=this.speed+50,this.info.refreshStatistic(),e="speed_up_bonus"),new o({game:this.game,asset:e,x:this.position.x,y:this.position.y})}increaseDelay(){let e="delay_up_no_bonus";this.delay>500&&(this.delay-=500,this.info.refreshStatistic(),e="delay_up_bonus"),new o({game:this.game,asset:e,x:this.position.x,y:this.position.y})}increasePower(){this.power+=1,this.info.refreshStatistic(),new o({game:this.game,asset:"power_up_bonus",x:this.position.x,y:this.position.y})}activateShield(){this.shieldUntil=this.game.time.now+1500,this.tint=6737151,this.game.time.events.add(1500,()=>{this.isGhosted&&this.isGhosted()?(this.tint=11007999,this.alpha=.65):this.tint=16777215}),new o({game:this.game,asset:"placeholder_time",x:this.position.x,y:this.position.y})}enableRemote(){this.hasRemote=!0,new o({game:this.game,asset:"placeholder_power",x:this.position.x,y:this.position.y})}enableKick(){this.hasKick=!0,new o({game:this.game,asset:"placeholder_speed",x:this.position.x,y:this.position.y})}activateGhost(){this.ghostUntil=this.game.time.now+4500,this.alpha=.65,this.tint=11007999,this.info&&this.info.showGhost&&this.info.showGhost(this.ghostUntil),this.game.time.events.add(4500,()=>{this.alpha=1,this.isShielded&&this.isShielded()||(this.tint=16777215),this.info&&this.info.hideGhost&&this.info.hideGhost()}),new o({game:this.game,asset:"ghost_icon",x:this.position.x,y:this.position.y})}defineSelf(t){let s=new e({game:this.game,x:17.5,y:-10,text:`âœ® ${t} âœ®`,style:{font:"15px Areal",fill:"#FFFFFF",stroke:"#000000",strokeThickness:3}});this.addChild(s)}}class k extends Phaser.Sprite{constructor({game:e,id:t,spawn:s,skin:i}){super(e,s.x,s.y,"bomberman_"+i),this.game=e,this.id=t,this.currentPosition=s,this.lastMoveAt=0,this.game.physics.arcade.enable(this),this.body.setSize(20,20,6,6),this.body.immovable=!0,this.animations.add("up",[9,10,11],15,!0),this.animations.add("down",[0,1,2],15,!0),this.animations.add("right",[6,7,8],15,!0),this.animations.add("left",[3,4,5],15,!0),this.defineSelf(i)}update(){}goTo(e){this.lastMoveAt=this.game.time.now,this.animateFace(e),this.game.add.tween(this).to(e,100,Phaser.Easing.Linear.None,!0)}animateFace(e){let t="down",s=e.x-this.currentPosition.x,i=e.y-this.currentPosition.y;s<0?t="left":s>0?t="right":i<0?t="up":i>0&&(t="down"),this.animations.play(t),this.currentPosition=e}defineSelf(t){let s=new e({game:this.game,x:17.5,y:-10,text:t,style:{font:"14px Areal",fill:"#FFFFFF",stroke:"#000000",strokeThickness:3}});this.addChild(s)}}class v extends Phaser.Sprite{constructor(e,t,s,i){super(e,s*c+17.5,i*c+17.5,"bomb_tileset"),this.scale.setTo(.7),this.anchor.setTo(.5),this.game=e,this.id=t,this.game.physics.arcade.enable(this),this.game.add.tween(this.scale).to({x:1.2,y:1.2},2e3,Phaser.Easing.Linear.None,!0),this.body.immovable=!0,this.animations.add("bomb",[0,1,2,3,4,5,6,7,8,9,10,11,12,13],6,!0),this.animations.play("bomb")}update(){}}class P extends Phaser.Sprite{constructor(e,t){let s=0;0===t.spoil_type&&(s=0),1===t.spoil_type&&(s=1),2===t.spoil_type&&(s=2),3===t.spoil_type&&(s=3),4===t.spoil_type&&(s=4),5===t.spoil_type&&(s=5),6===t.spoil_type&&(s=6),super(e,t.col*c,t.row*c,"spoil_tileset",s),this.id=t.id,this.game.physics.arcade.enable(this),this.alpha=.92,this.scale.setTo(1);try{const e=this.game.add.tween(this).to({alpha:.62},420,Phaser.Easing.Sinusoidal.InOut,!0,0,-1,!0),t=this.game.add.tween(this.scale).to({x:1.08,y:1.08},520,Phaser.Easing.Sinusoidal.InOut,!0,0,-1,!0);this._glowTween=e,this._scaleTween=t}catch(e){}}}class S extends Phaser.Sprite{constructor(e,t){super(e,t.col*c,t.row*c,t.type,0),this.game=e,this.animations.add("blast",[0,1,2,3,4]),this.play("blast",15,!1,!0),this.game.physics.arcade.enable(this)}}class T extends Phaser.Sprite{constructor(e,t,s){super(e,t*c,s*c,"bone_tileset")}}class F extends Phaser.State{init(e){this.currentGame=e}create(){this.createMap(),this.createPlayers(),this.setEventHandlers(),this.player&&this.game.camera.follow(this.player),this.createTouchControls(),this.sfxPortal=this.game.add.audio("sfx_portal"),this.sfxSpeed=this.game.add.audio("sfx_speed"),this.game.time.events.loop(400,this.stopAnimationLoop.bind(this))}update(){this.refreshGhostCollision(),this.game.physics.arcade.collide(this.player,this.blockLayer),this.game.physics.arcade.collide(this.player,this.enemies),this.game.physics.arcade.collide(this.player,this.bombs,this.onPlayerVsBomb,null,this),this.game.physics.arcade.overlap(this.player,this.spoils,this.onPlayerVsSpoil,null,this),this.game.physics.arcade.overlap(this.player,this.blasts,this.onPlayerVsBlast,null,this),this.handleSpecialTiles()}createMap(){this.map=this.add.tilemap(this.currentGame.map_name),this.map.addTilesetImage("tiles"),this.blockLayer=this.map.createLayer("Blocks"),this.blockLayer.resizeWorld(),this.baseCollisionTiles=(this.blockLayer.layer.properties.collisionTiles||[]).slice(),this.wallTileIndex=this.blockLayer.layer.properties.wall,this.balkTileIndex=this.blockLayer.layer.properties.balk,this.map.setCollision(this.baseCollisionTiles,!0,this.blockLayer),this._ghostCollisionEnabled=!1,this.portalCells=[],this.speedCells=new Set,this.specialFx=this.game.add.group();const e=this.map.layers[0],t=e.width,s=e.height,i=e.data;for(let e=0;e<s;e++)for(let s=0;s<t;s++){const t=i[e][s];if(!t)continue;const a=t.index;2===a?this.portalCells.push({col:s,row:e}):3===a&&this.speedCells.add(`${s},${e}`)}for(const e of this.portalCells){const t=e.col*c,s=e.row*c,i=this.game.add.sprite(t,s,"portal_fx");i.alpha=.95,i.blendMode=Phaser.blendModes.ADD,i.animations.add("spin",[0,1,2,3,4,5],10,!0),i.animations.play("spin"),this.specialFx.add(i)}for(const e of this.speedCells){const[t,s]=e.split(",").map(Number),i=t*c,a=s*c,o=this.game.add.sprite(i,a,"speed_fx");o.alpha=.75,o.animations.add("flow",[0,1,2,3,4,5],12,!0),o.animations.play("flow"),this.specialFx.add(o)}this.player=null,this.bones=this.game.add.group(),this.bombs=this.game.add.group(),this.spoils=this.game.add.group(),this.blasts=this.game.add.group(),this.enemies=this.game.add.group(),this.game.physics.arcade.enable(this.blockLayer)}createPlayers(){for(let e of Object.values(this.currentGame.players)){let t={game:this.game,id:e.id,spawn:e.spawn,skin:e.skin};e.id===clientSocket.id?this.player=new x(t):this.enemies.add(new k(t))}}setEventHandlers(){clientSocket.on("move player",this.onMovePlayer.bind(this)),clientSocket.on("player win",this.onPlayerWin.bind(this)),clientSocket.on("show bomb",this.onShowBomb.bind(this)),clientSocket.on("detonate bomb",this.onDetonateBomb.bind(this)),clientSocket.on("move bomb",this.onMoveBomb.bind(this)),clientSocket.on("spoil was picked",this.onSpoilWasPicked.bind(this)),clientSocket.on("show bones",this.onShowBones.bind(this)),clientSocket.on("player disconnect",this.onPlayerDisconnect.bind(this))}onPlayerVsSpoil(e,t){clientSocket.emit("pick up spoil",{spoil_id:t.id}),t.kill()}onPlayerVsBlast(e,t){e.alive&&(e.isShielded&&e.isShielded()||(clientSocket.emit("player died",{col:e.currentCol(),row:e.currentRow()}),e.becomesDead()))}onMovePlayer({player_id:e,x:t,y:s}){let i=w(e,this.enemies);i&&i.goTo({x:t,y:s})}onPlayerVsBomb(e,t){if(!e||!t)return;if(!e.hasKick)return;const s=e.leftKey.isDown||e.aKey&&e.aKey.isDown||e.touchLeft,i=e.rightKey.isDown||e.dKey&&e.dKey.isDown||e.touchRight,a=e.upKey.isDown||e.wKey&&e.wKey.isDown||e.touchUp,o=e.downKey.isDown||e.sKey&&e.sKey.isDown||e.touchDown;let h=null;if(s?h="left":i?h="right":a?h="up":o&&(h="down"),!h)return;const n=this.game.time.now;e._lastKickAt||(e._lastKickAt=0),n-e._lastKickAt<110||(e._lastKickAt=n,clientSocket.emit("kick bomb",{bomb_id:t.id,dir:h}))}onMoveBomb({bomb_id:e,col:t,row:s}){const i=w(e,this.bombs);if(!i)return;const a=t*c+17.5,o=s*c+17.5;i.x=a,i.y=o,i.body&&i.body.reset(a,o)}stopAnimationLoop(){for(let e of this.enemies.children)e.lastMoveAt<this.game.time.now-200&&e.animations.stop()}createTouchControls(){if(!this.player)return;if(!(this.game.device&&(this.game.device.touch||this.game.device.iOS||this.game.device.android)||"undefined"!=typeof window&&"ontouchstart"in window||"undefined"!=typeof navigator&&navigator.maxTouchPoints>0))return;const e=this.game.add.group();e.fixedToCamera=!0,e.cameraOffset.setTo(0,0);const t=this.game.width,s=this.game.height,i=(()=>{try{const e=getComputedStyle(document.documentElement).getPropertyValue("env(safe-area-inset-bottom)"),t=parseInt((e||"0").toString().replace("px","").trim(),10);return Number.isFinite(t)?t:0}catch(e){return 0}})(),a=Math.max(28,i+18),o=Math.max(.85,Math.min(1.15,Math.min(t,s)/700)),h=125*o,n=s-185*o-a,l=70*o,r=36*o,m=this.game.add.graphics(0,0);m.beginFill(1118481,.22),m.lineStyle(3,16777215,.18),m.drawCircle(0,0,2*l),m.endFill(),m.x=h,m.y=n,m.inputEnabled=!0,m.input.enableDrag(!1),e.add(m);const d=this.game.add.graphics(0,0);d.beginFill(58879,.18),d.lineStyle(3,58879,.25),d.drawCircle(0,0,2*r),d.endFill(),d.x=h,d.y=n,e.add(d);const p=()=>{this.player.touchLeft=this.player.touchRight=this.player.touchUp=this.player.touchDown=!1},c=(e,t)=>{if(p(),Math.abs(e)<14&&Math.abs(t)<14)return d.x=h,void(d.y=n);Math.abs(e)>Math.abs(t)?(e>0?this.player.touchRight=!0:this.player.touchLeft=!0,d.x=h+Math.max(-l+r,Math.min(l-r,e)),d.y=n):(t>0?this.player.touchDown=!0:this.player.touchUp=!0,d.x=h,d.y=n+Math.max(-l+r,Math.min(l-r,t)))},g=e=>{const t=e.x-h,s=e.y-n,i=Math.sqrt(t*t+s*s)||1,a=l-r,o=Math.min(a,i);c(t/i*o,s/i*o)};m.events.onInputDown.add((e,t)=>g(t)),m.events.onInputUp.add(()=>{p(),d.x=h,d.y=n}),m.events.onInputOut.add(()=>{p(),d.x=h,d.y=n}),this.game.input.addMoveCallback(e=>{e.isDown&&g(e)},this),(({x:t,y:s,r:i=44,label:a,onDown:o,onUp:h,fill:n=1118481,alpha:l=.35,stroke:r=16777215,strokeAlpha:m=.22})=>{const d=this.game.add.graphics(0,0);d.beginFill(n,l),d.lineStyle(3,r,m),d.drawCircle(0,0,2*i),d.endFill(),d.x=t,d.y=s;const p=this.game.add.text(0,0,a,{font:"26px Arial",fill:"#ffffff"});p.anchor.setTo(.5),d.addChild(p),d.inputEnabled=!0,d.events.onInputDown.add(()=>o&&o());const c=()=>h&&h();d.events.onInputUp.add(c),d.events.onInputOut.add(c),e.add(d)})({x:t-115*o,y:s-165*o-a,r:54*o,label:"ðŸ’£",fill:8002815,alpha:.32,stroke:58879,strokeAlpha:.35,onDown:()=>this.player.touchBomb=!0,onUp:()=>this.player.touchBomb=!1}),this.game.scale.onSizeChange.add(()=>{this.game.width,this.game.height,e.destroy(!0),this.createTouchControls()})}refreshGhostCollision(){if(!this.player)return;const e=this.player.isGhosted&&this.player.isGhosted();e!==this._ghostCollisionEnabled&&(this._ghostCollisionEnabled=e,e?(this.map.setCollision([this.wallTileIndex],!0,this.blockLayer),null!=this.balkTileIndex&&this.map.setCollision([this.balkTileIndex],!1,this.blockLayer)):this.map.setCollision(this.baseCollisionTiles,!0,this.blockLayer))}handleSpecialTiles(){if(!this.player)return;const e=Math.floor(this.player.body.position.x/c),t=Math.floor(this.player.body.position.y/c),s=this.speedCells.has(`${e},${t}`);if(this.player.tileSpeedMultiplier=s?1.65:1,this.player._wasOnSpeed||(this.player._wasOnSpeed=!1),s&&!this.player._wasOnSpeed)try{this.sfxSpeed&&this.sfxSpeed.play()}catch(e){}if(this.player._wasOnSpeed=s,this.portalCells.length>=2){const s=this.game.time.now;this.player._lastPortalAt||(this.player._lastPortalAt=0);const i=this.portalCells.findIndex(s=>s.col===e&&s.row===t);if(i>=0&&s-this.player._lastPortalAt>900){const e=i%2==0?i+1:i-1,t=this.portalCells[e];if(t){this.player.x=t.col*c,this.player.y=t.row*c,this.player.body.velocity.set(0),this.player.body.reset(this.player.x,this.player.y),this.player.prevPosition={x:this.player.x,y:this.player.y},this.player._lastPortalAt=s;try{this.sfxPortal&&this.sfxPortal.play()}catch(e){}}}}}onShowBomb({bomb_id:e,col:t,row:s}){this.bombs.add(new v(this.game,e,t,s))}onDetonateBomb({bomb_id:e,blastedCells:t}){_(e,this.bombs);for(let e of t)this.blasts.add(new S(this.game,e));for(let e of t)e.destroyed&&this.map.putTile(this.blockLayer.layer.properties.empty,e.col,e.row,this.blockLayer);for(let e of t)e.destroyed&&e.spoil&&this.spoils.add(new P(this.game,e.spoil))}onSpoilWasPicked({player_id:e,spoil_id:t,spoil_type:s}){e===this.player.id&&this.player.pickSpoil(s),_(t,this.spoils)}onShowBones({player_id:e,col:t,row:s}){this.bones.add(new T(this.game,t,s)),_(e,this.enemies)}onPlayerWin(e){clientSocket.emit("leave game");const t=e&&e.skin?e.skin:e;this.state.start("Win",!0,!1,t)}onPlayerDisconnect({player_id:e}){_(e,this.enemies),this.enemies.children.length>=1||this.onPlayerWin()}}const C=F;class A extends Phaser.State{init(e){this.skin=e}create(){new e({game:this.game,x:this.game.world.centerX,y:this.game.world.centerY,text:this.winnerText(),style:{font:"30px Areal",fill:"#FFFFFF"}})}update(){this.game.input.keyboard.isDown(Phaser.Keyboard.ENTER)&&this.returnToMenu()}returnToMenu(){this.state.start("Menu")}winnerText(){return this.skin?`Player: "${this.skin}" won! Press Enter to return to main menu.`:"Opponent left! Press Enter to return to main menu."}}const K=A;class D extends Phaser.Game{constructor(){super(980,630,Phaser.AUTO,"game-container"),this.config.forceSetTimeOut=!0,this.state.add("Boot",n),this.state.add("Preload",r),this.state.add("Menu",d),this.state.add("SelectMap",y),this.state.add("PendingGame",b),this.state.add("Play",C),this.state.add("Win",K),this.state.start("Boot")}}new D})();
//# sourceMappingURL=bundle.js.map