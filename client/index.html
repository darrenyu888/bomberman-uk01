<!doctype html>
<html lang='en'>
<head>
  <title>Bomb Attack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <link rel='stylesheet' href='css/base.css'/>

  <script src='lib/phase-slide.js'></script>
  <script src='lib/phaser.min.js'></script>
  <script src='/socket.io/socket.io.js'></script>

  <!-- Google Identity Services is loaded dynamically after /api/config -->

  <script>
    // Socket.IO
    window.clientSocket = io.connect();

    // Minimal auth overlay (no webpack build needed)
    async function initAuthOverlay() {
      const el = document.getElementById('auth-overlay');
      const statusEl = document.getElementById('auth-status');
      const nameEl = document.getElementById('auth-name');
      const saveBtn = document.getElementById('auth-save-name');
      const logoutBtn = document.getElementById('auth-logout');
      const gBtn = document.getElementById('google-btn');
      const toggleBtn = document.getElementById('auth-toggle');

      toggleBtn.addEventListener('click', () => {
        el.classList.toggle('minimized');
      });

      async function refreshMe() {
        const r = await fetch('/api/me');
        const data = await r.json();
        if (data && data.user) {
          statusEl.textContent = `已登入：${data.user.displayName}`;
          // auto-minimize after login to avoid blocking gameplay
          el.classList.add('minimized');
          nameEl.value = data.user.displayName || '';
          logoutBtn.style.display = 'inline-block';
          saveBtn.style.display = 'inline-block';
        } else {
          statusEl.textContent = '未登入（可匿名遊玩）';
          logoutBtn.style.display = 'none';
          saveBtn.style.display = 'none';
        }
      }

      saveBtn.addEventListener('click', async () => {
        const displayName = (nameEl.value || '').trim();
        const r = await fetch('/api/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ displayName })
        });
        const data = await r.json();
        if (!r.ok) {
          alert(data.message || data.error || '更新失敗');
          return;
        }
        await refreshMe();
      });

      logoutBtn.addEventListener('click', async () => {
        await fetch('/auth/logout', { method: 'POST' });
        await refreshMe();
        location.reload();
      });

      // load config then GIS
      const cfg = await (await fetch('/api/config')).json();
      if (!cfg.googleClientId) {
        gBtn.textContent = 'Google 登入未設定（缺 GOOGLE_CLIENT_ID）';
        gBtn.disabled = true;
        await refreshMe();
        return;
      }

      // Load Google script
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://accounts.google.com/gsi/client';
        s.async = true;
        s.defer = true;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });

      window.google.accounts.id.initialize({
        client_id: cfg.googleClientId,
        callback: async (resp) => {
          const r = await fetch('/auth/google', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ credential: resp.credential })
          });
          const data = await r.json();
          if (!r.ok) {
            alert(data.error || '登入失敗');
            return;
          }
          await refreshMe();
          // ensure socket reconnects with cookie
          window.clientSocket.disconnect();
          window.clientSocket.connect();
        }
      });

      // Render a real Google button inside #google-render
      const render = document.getElementById('google-render');
      window.google.accounts.id.renderButton(render, { theme: 'outline', size: 'medium' });
      gBtn.style.display = 'none';

      await refreshMe();
    }

    window.addEventListener('load', initAuthOverlay);
  </script>

  <script src='bundle.js'></script>
</head>
<body>
  <div id='auth-overlay' class='minimized'>
    <div class='auth-row' style='margin-top:0'>
      <div id='auth-status' style='flex:1'>載入中…</div>
      <button id='auth-toggle' title='顯示/收合'>帳號</button>
    </div>

    <div id='auth-body'>
      <div class='auth-row'>
        <div id='google-render'></div>
        <button id='google-btn'>Google 登入</button>
        <button id='auth-logout' style='display:none'>登出</button>
      </div>
      <div class='auth-row'>
        <input id='auth-name' placeholder='自訂名稱 (1..24)' maxlength='24' />
        <button id='auth-save-name' style='display:none'>儲存名稱</button>
      </div>
    </div>
  </div>

  <div id='menu-overlay' class='menu-overlay hidden'>
    <div class='menu-panel'>
      <div class='menu-title'>Main Menu</div>
      <button id='btn-new-game' class='menu-btn'>New Game</button>

      <div id='map-picker' class='hidden'>
        <div class='menu-title'>Select Map</div>
        <div class='map-grid'>
          <button class='map-btn' data-map='hot_map'>Hot</button>
          <button class='map-btn' data-map='cold_map'>Cold</button>
          <button class='map-btn' data-map='arena_map'>Arena</button>
          <button class='map-btn' data-map='open_map'>Open</button>
          <button class='map-btn' data-map='rune_lab'>Rune Lab</button>
          <button class='map-btn' data-map='mirror_temple'>Mirror</button>
          <button class='map-btn' data-map='trap_garden'>Trap</button>
        </div>
        <div class='menu-row'>
          <button id='btn-map-back' class='menu-btn secondary'>Back</button>
        </div>
      </div>
    </div>
  </div>

  <div id='pending-overlay' class='menu-overlay hidden'>
    <div class='menu-panel'>
      <div id='pending-title' class='menu-title'>Pending Game</div>

      <div class='menu-row'>
        <div class='menu-subtitle'>AI 數量</div>
        <div class='inline-controls'>
          <button id='ai-minus' class='chip'>-</button>
          <div id='ai-count' class='chip label'>3</div>
          <button id='ai-plus' class='chip'>+</button>
        </div>
      </div>

      <div class='menu-row'>
        <div class='menu-subtitle'>AI 難度</div>
        <div class='inline-controls'>
          <button class='chip diff' data-diff='easy'>Easy</button>
          <button class='chip diff active' data-diff='normal'>Normal</button>
          <button class='chip diff' data-diff='hard'>Hard</button>
        </div>
      </div>

      <div class='menu-row'>
        <button id='btn-start-game' class='menu-btn'>Start Game</button>
      </div>
      <div class='menu-row'>
        <button id='btn-leave-game' class='menu-btn secondary'>Leave</button>
      </div>
    </div>
  </div>

  <div id='game-wrapper'>
    <div id='game-container'></div>
  </div>

  <script>
    // HTML Menu overlay controller (more reliable on mobile than Phaser buttons)
    (function(){
      const menu = document.getElementById('menu-overlay');
      const mapPicker = document.getElementById('map-picker');
      const btnNew = document.getElementById('btn-new-game');
      const btnBack = document.getElementById('btn-map-back');

      function showMenu() {
        menu.classList.remove('hidden');
        mapPicker.classList.add('hidden');
        btnNew.style.display = 'block';
      }
      function showMaps() {
        mapPicker.classList.remove('hidden');
        btnNew.style.display = 'none';
      }
      function hideMenu() {
        menu.classList.add('hidden');
      }

      // Expose so Phaser states can toggle
      window.UK01Menu = { showMenu, showMaps, hideMenu };

      btnNew.addEventListener('click', () => {
        showMaps();
      });

      btnBack.addEventListener('click', () => {
        showMenu();
      });

      // Map choose
      menu.addEventListener('click', (e) => {
        const b = e.target && e.target.closest && e.target.closest('.map-btn');
        if (!b) return;
        const map = b.getAttribute('data-map');
        if (!map) return;

        try {
          // mirror Phaser flow
          window.clientSocket.emit('leave lobby');
        } catch (_) {}

        window.clientSocket.emit('create game', map, (payload) => {
          if (payload && payload.error) {
            alert(payload.message || payload.error);
            return;
          }
          const game_id = (payload && payload.game_id) ? payload.game_id : payload;
          hideMenu();
          // Start pending game state
          try {
            window.__phaserGame && window.__phaserGame.state && window.__phaserGame.state.start('PendingGame', true, false, game_id);
          } catch (_) {
            // fallback: reload
            location.reload();
          }
        });
      });

      // Default show menu immediately
      showMenu();
    })();
  </script>

  <script>
    // Pending Game overlay controller (AI count/difficulty + start)
    (function(){
      const pending = document.getElementById('pending-overlay');
      const titleEl = document.getElementById('pending-title');
      const aiCountEl = document.getElementById('ai-count');
      const btnMinus = document.getElementById('ai-minus');
      const btnPlus = document.getElementById('ai-plus');
      const btnStart = document.getElementById('btn-start-game');
      const btnLeave = document.getElementById('btn-leave-game');

      let aiCount = 3;
      let aiDiff = 'normal';

      function show() {
        pending.classList.remove('hidden');
      }
      function hide() {
        pending.classList.add('hidden');
      }
      function setCount(n) {
        aiCount = Math.max(0, Math.min(3, n));
        aiCountEl.textContent = String(aiCount);
        try { window.clientSocket.emit('set ai count', { count: aiCount }); } catch(_){}
      }
      function setDiff(d) {
        aiDiff = d;
        // toggle UI
        pending.querySelectorAll('.chip.diff').forEach(el => {
          el.classList.toggle('active', el.getAttribute('data-diff') === aiDiff);
        });
        try { window.clientSocket.emit('set ai difficulty', { difficulty: aiDiff }); } catch(_){}
      }

      function updateFromGame(current_game) {
        if (!current_game) return;
        if (current_game.name) titleEl.textContent = current_game.name;

        // enable start when at least 1 player
        const players = current_game.players ? Object.keys(current_game.players).length : 0;
        btnStart.disabled = !(players >= 1);
        btnStart.style.opacity = btnStart.disabled ? '0.55' : '1';
      }

      btnMinus.addEventListener('click', () => setCount(aiCount - 1));
      btnPlus.addEventListener('click', () => setCount(aiCount + 1));

      pending.addEventListener('click', (e) => {
        const b = e.target && e.target.closest && e.target.closest('.chip.diff');
        if (!b) return;
        const d = b.getAttribute('data-diff');
        if (d) setDiff(d);
      });

      btnStart.addEventListener('click', () => {
        try { window.clientSocket.emit('start game'); } catch(_){}
        hide();
      });

      btnLeave.addEventListener('click', () => {
        try { window.clientSocket.emit('leave pending game'); } catch(_){}
        hide();
        try { window.UK01Menu && window.UK01Menu.showMenu && window.UK01Menu.showMenu(); } catch(_){}
        try { window.__phaserGame && window.__phaserGame.state && window.__phaserGame.state.start('Menu'); } catch(_){}
      });

      // Expose
      window.UK01Pending = {
        show,
        hide,
        updateFromGame,
        setCount,
        setDiff,
      };

      // init UI
      setCount(aiCount);
      setDiff(aiDiff);
    })();
  </script>
</body>
</html>
